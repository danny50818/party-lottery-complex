<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸ 8-Bit æŠ½çç³»çµ±</title>
  <!-- Pixel font + å¾®è»Ÿæ­£é»‘é«” -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --bg-main: #2b0000;
      --accent: #ff5555;
      --accent2: #ffd700;
      --pixel-border: 4px;
      --font-pixel: "Press Start 2P", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
      --font-zh: "Microsoft JhengHei", system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      background: var(--bg-main);
      color: #fff;
      font-family: var(--font-zh);
      overflow: hidden;
    }

    body {
      position: relative;
    }

    /* æµå‹•ç¶²æ ¼èƒŒæ™¯ */
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image:
        radial-gradient(circle at top, rgba(255, 60, 60, 0.6), transparent 60%),
        linear-gradient(#400000, #000000 60%);
      overflow: hidden;
      z-index: -2;
    }
    .bg-grid::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(
          rgba(255, 0, 0, 0.25) 1px,
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(255, 0, 0, 0.25) 1px,
          transparent 1px
        );
      background-size: 40px 40px;
      transform-origin: bottom center;
      animation: grid-flow 15s linear infinite;
      opacity: 0.7;
    }

    @keyframes grid-flow {
      0% {
        transform: perspective(600px) rotateX(70deg) translateY(0);
      }
      100% {
        transform: perspective(600px) rotateX(70deg) translateY(40px);
      }
    }

    .pixel-frame {
      border: var(--pixel-border) solid #ffcccc;
      box-shadow: 0 0 0 4px #440000, 0 0 0 8px #ff5555;
      background: rgba(0, 0, 0, 0.6);
      padding: 16px;
      border-radius: 4px;
    }

    .pixel-btn {
      display: inline-block;
      padding: 8px 16px;
      margin: 4px;
      border: var(--pixel-border) solid #fff;
      background: #990000;
      box-shadow: 0 0 0 4px #440000;
      color: #fff;
      font-family: var(--font-pixel);
      font-size: 10px;
      text-transform: uppercase;
      cursor: pointer;
      text-align: center;
    }
    .pixel-btn:active {
      transform: translateY(2px);
      box-shadow: 0 0 0 2px #440000;
    }

    .pixel-input,
    .pixel-select {
      padding: 6px 8px;
      border: var(--pixel-border) solid #fff;
      background: #220000;
      color: #fff;
      font-family: var(--font-zh);
      font-size: 14px;
      margin: 4px 0;
      width: 100%;
    }

    .layout {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 8px;
    }

    .header {
      font-family: var(--font-pixel);
      font-size: 14px;
      text-shadow: 0 0 4px #ff8888;
      margin-bottom: 4px;
    }

    .sub-header {
      font-size: 14px;
      opacity: 0.85;
      margin-bottom: 8px;
    }

    .row {
      display: flex;
      gap: 16px;
      height: calc(100% - 60px);
    }

    .col-left,
    .col-right {
      display: flex;
      flex-direction: column;
    }

    .col-left {
      flex: 2;
      min-width: 0;
    }

    .col-right {
      flex: 1;
      min-width: 0;
      gap: 8px;
    }

    #animationArea {
      flex: 1;
      min-height: 0;
      position: relative;
      overflow: hidden;
      border-radius: 4px;
    }

    .status-panel {
      font-size: 13px;
      line-height: 1.4;
      max-height: 50%;
      overflow: auto;
    }

    .status-panel h3 {
      font-family: var(--font-pixel);
      font-size: 10px;
      margin-bottom: 4px;
    }

    .status-panel ul {
      list-style: none;
      padding-left: 0;
      margin-top: 4px;
    }

    .status-panel li {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .tag {
      display: inline-block;
      padding: 2px 6px;
      margin-right: 4px;
      border-radius: 2px;
      font-size: 11px;
      background: #660000;
      color: #ffd700;
      font-family: var(--font-pixel);
    }

    .small {
      font-size: 11px;
      opacity: 0.8;
    }

    /* ç©å®¶ç•«é¢ */
    .player-layout {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      text-align: center;
    }

    .player-no {
      font-family: var(--font-pixel);
      font-size: 20px;
      color: var(--accent2);
      text-shadow: 0 0 8px #ffcc00;
      margin-top: 8px;
    }

    .player-name {
      font-size: 18px;
      margin-top: 4px;
    }

    .player-status {
      font-size: 14px;
      margin-top: 8px;
    }

    .win-banner {
      font-family: var(--font-pixel);
      font-size: 22px;
      color: #00ffea;
      text-shadow: 0 0 10px #00ffff;
      animation: win-blink 0.5s steps(2, jump-none) infinite;
      margin-top: 12px;
    }

    @keyframes win-blink {
      0% {
        opacity: 1;
      }
      50% {
        opacity: 0.2;
      }
      100% {
        opacity: 1;
      }
    }

    /* å‹•ç•«å€å…±æœ‰å…ƒç´  */
    .anim-root {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      font-size: 14px;
    }

    .anim-title {
      position: absolute;
      top: 4px;
      left: 8px;
      font-family: var(--font-pixel);
      font-size: 10px;
      opacity: 0.75;
    }

    .anim-phase-label {
      position: absolute;
      top: 4px;
      right: 8px;
      font-family: var(--font-pixel);
      font-size: 10px;
      color: #ffd700;
    }

    .winner-display {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      font-size: 14px;
    }

    .winner-display .no {
      font-family: var(--font-pixel);
      font-size: 16px;
      color: #ffd700;
      text-shadow: 0 0 6px #ffd700;
    }

    .winner-display .name {
      font-size: 14px;
      margin-top: 2px;
    }

    /* 1. åƒç´ è³½è»Š */
    .race-track {
      width: 100%;
      height: 70%;
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      padding: 8px 16px;
    }

    .race-lane {
      position: relative;
      height: 14%;
      border-top: 1px dashed rgba(255, 255, 255, 0.2);
      border-bottom: 1px dashed rgba(255, 255, 255, 0.2);
    }

    .race-car {
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      filter: drop-shadow(0 0 4px #ffaaaa);
    }

    .race-car.running {
      animation: race-run 8s linear forwards;
    }

    .race-car.winner {
      filter: drop-shadow(0 0 8px #ffd700);
    }

    .race-finish {
      position: absolute;
      right: 5%;
      top: 0;
      bottom: 0;
      width: 6px;
      background-image: linear-gradient(
        to bottom,
        #ffffff 50%,
        #000000 50%
      );
      background-size: 6px 12px;
    }

    @keyframes race-run {
      0% {
        transform: translate(0, -50%);
      }
      100% {
        transform: translate(70vw, -50%);
      }
    }

    /* 2. æ‹‰éœ¸ */
    .slots-container {
      display: flex;
      gap: 8px;
      padding: 12px;
      background: #220000;
      border-radius: 4px;
      border: 3px solid #ffaaaa;
      box-shadow: 0 0 0 4px #440000;
    }

    .slot-window {
      width: 80px;
      height: 80px;
      overflow: hidden;
      border: 3px solid #ffffff;
      background: #000000;
      position: relative;
    }

    .slot-strip {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      will-change: transform;
    }

    .slot-item {
      height: 40px;
      width: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .slot-window.reveal {
      border-color: #ffd700;
      box-shadow: 0 0 10px #ffd700;
    }

    /* 3. å¤¾å¨ƒå¨ƒæ©Ÿ */
    .claw-scene {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .claw-rail {
      position: absolute;
      top: 10%;
      left: 10%;
      right: 10%;
      height: 4px;
      background: #cccccc;
    }

    .claw-head {
      position: absolute;
      top: 10%;
      font-size: 28px;
      transform: translateX(0);
    }

    .claw-item {
      position: absolute;
      bottom: 8%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 28px;
    }

    .claw-head.move-horiz {
      animation: claw-move-h 3s ease-in-out infinite alternate;
    }

    @keyframes claw-move-h {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(60vw);
      }
    }

    /* å‚ç›´ç§»å‹•ç”¨ JS ç›´æ¥æ›´æ”¹ transform */

    /* 4. æµæ˜Ÿ */
    .meteor-scene {
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    .meteor {
      position: absolute;
      left: 110%;
      top: -10%;
      font-size: 30px;
      transform: translate(0, 0);
      filter: drop-shadow(0 0 6px #ffddaa);
    }

    .meteor.fly {
      animation: meteor-fall 1.2s linear forwards;
    }

    @keyframes meteor-fall {
      0% {
        transform: translate(0, 0);
      }
      100% {
        transform: translate(-140vw, 70vh);
      }
    }

    .shake {
      animation: screen-shake 0.3s linear 4;
    }

    @keyframes screen-shake {
      0% {
        transform: translate(0, 0);
      }
      25% {
        transform: translate(-4px, 2px);
      }
      50% {
        transform: translate(3px, -3px);
      }
      75% {
        transform: translate(-2px, 3px);
      }
      100% {
        transform: translate(0, 0);
      }
    }

    .flash {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9), transparent);
      animation: flash-pop 0.4s ease-out forwards;
      pointer-events: none;
    }

    @keyframes flash-pop {
      0% {
        opacity: 0;
      }
      30% {
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }

    /* 5. å†’éšªå³¶ */
    .adventure-scene {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }

    .adventure-ground {
      width: 100%;
      height: 25%;
      background: repeating-linear-gradient(
        -45deg,
        #663300,
        #663300 8px,
        #884400 8px,
        #884400 16px
      );
      position: relative;
      overflow: hidden;
    }

    .adventure-runner {
      position: absolute;
      left: 5%;
      bottom: 35%;
      font-size: 26px;
    }

    .adventure-runner.run {
      animation: adv-run 6s linear infinite;
    }

    @keyframes adv-run {
      0% {
        transform: translateX(0);
      }
      100% {
        transform: translateX(80vw);
      }
    }

    .adv-block {
      position: absolute;
      left: 50%;
      top: 30%;
      width: 40px;
      height: 40px;
      background: #ffcc00;
      border: 3px solid #000;
      box-shadow: 0 0 0 3px #ff8800;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-pixel);
      font-size: 14px;
      color: #000;
    }

    .adv-prize {
      position: absolute;
      left: 50%;
      top: 16%;
      transform: translateX(-50%);
      font-size: 18px;
      opacity: 0;
      animation: adv-prize-pop 1s ease-out forwards;
    }

    @keyframes adv-prize-pop {
      0% {
        opacity: 0;
        transform: translate(-50%, 10px);
      }
      100% {
        opacity: 1;
        transform: translate(-50%, -10px);
      }
    }

    .adv-jump {
      animation: adv-jump 0.8s ease-out forwards;
    }

    @keyframes adv-jump {
      0% {
        transform: translateX(0) translateY(0);
      }
      50% {
        transform: translateX(30vw) translateY(-40px);
      }
      100% {
        transform: translateX(60vw) translateY(0);
      }
    }

    /* 6. å¤ªç©ºå°„æ“Š */
    .shooter-scene {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .shooter-ship {
      position: absolute;
      bottom: 12%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
    }

    .shooter-ship.move {
      animation: ship-move 4s ease-in-out infinite alternate;
    }

    @keyframes ship-move {
      0% {
        transform: translateX(-40vw);
      }
      100% {
        transform: translateX(40vw);
      }
    }

    .shooter-target {
      position: absolute;
      top: 12%;
      left: 50%;
      transform: translateX(-50%);
      font-size: 26px;
    }

    .laser {
      position: absolute;
      width: 4px;
      height: 20px;
      background: #00ffff;
      box-shadow: 0 0 8px #00ffff;
      bottom: 15%;
      left: 50%;
      transform: translateX(-50%);
    }

    .laser.fly {
      animation: laser-fly 0.8s linear forwards;
    }

    @keyframes laser-fly {
      0% {
        bottom: 15%;
      }
      100% {
        bottom: 70%;
      }
    }

    .target-hit {
      animation: target-blast 0.4s steps(2) 3;
    }

    @keyframes target-blast {
      0% {
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateX(-50%) scale(1.6);
        opacity: 0;
      }
    }

    /* 7. å¹¸é‹è½‰ç›¤ */
    .wheel-scene {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wheel {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 6px solid #ffffff;
      box-shadow: 0 0 0 4px #ff5555;
      background-image: conic-gradient(
        #ff5555 0deg 45deg,
        #ffaa00 45deg 90deg,
        #33ccff 90deg 135deg,
        #66ff66 135deg 180deg,
        #ff66cc 180deg 225deg,
        #ffff66 225deg 270deg,
        #ff9966 270deg 315deg,
        #66ccff 315deg 360deg
      );
      position: relative;
    }

    .wheel.fast {
      animation: wheel-fast 2s linear infinite;
    }

    .wheel.slow {
      animation: wheel-slow 3s ease-out forwards;
    }

    @keyframes wheel-fast {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(720deg);
      }
    }

    @keyframes wheel-slow {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .wheel-label {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-pixel);
      font-size: 10px;
      text-align: center;
    }

    .pointer {
      position: absolute;
      top: calc(50% - 130px);
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 24px solid #ffffff;
      filter: drop-shadow(0 0 4px #ffffff);
    }

    /* 8. å¡”ç¾…ç¿»ç‰Œ */
    .tarot-scene {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
    }

    .tarot-card {
      width: 90px;
      height: 140px;
      border-radius: 6px;
      border: 4px solid #ffffff;
      background: #111133;
      position: relative;
      transform-style: preserve-3d;
      transform-origin: center;
      transition: transform 0.8s ease-out;
    }

    .tarot-card-face {
      position: absolute;
      inset: 0;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-pixel);
      font-size: 10px;
    }

    .tarot-back {
      background: repeating-linear-gradient(
        45deg,
        #660000,
        #660000 8px,
        #cc0000 8px,
        #cc0000 16px
      );
    }

    .tarot-front {
      transform: rotateY(180deg);
      background: #222244;
      border-radius: 4px;
      border: 2px solid #ffd700;
      text-align: center;
      padding: 6px;
    }

    .tarot-card.flip {
      transform: rotateY(180deg);
    }

    .tarot-card.shuffle {
      animation: tarot-shuffle 0.5s ease-in-out infinite alternate;
    }

    @keyframes tarot-shuffle {
      0% {
        transform: translateY(0) rotateZ(0deg);
      }
      100% {
        transform: translateY(-6px) rotateZ(3deg);
      }
    }

    /* å…¬ç”¨éŒ¯èª¤è¨Šæ¯ */
    .error-message {
      color: #ffaaaa;
      font-size: 12px;
      margin-top: 4px;
    }

    /* å°è¢å¹•é©æ‡‰ */
    @media (max-width: 900px) {
      .row {
        flex-direction: column;
        height: auto;
      }
      .col-left,
      .col-right {
        flex: none;
        height: auto;
      }
      #animationArea {
        height: 260px;
      }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="layout" id="adminLayout" style="display:none;">
    <div class="header">ğŸ† å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸ - 8-Bit PIXEL LOTTERY</div>
    <div class="sub-header">
      <span class="tag">HOST CONSOLE</span>
      <span class="small">ä½¿ç”¨ <strong>?mode=player</strong> è®“æ‰‹æ©ŸåŠ å…¥æŠ½ç</span>
    </div>
    <div class="row">
      <div class="col-left">
        <div id="animationArea" class="pixel-frame"></div>
      </div>
      <div class="col-right">
        <div class="pixel-frame" style="margin-bottom:8px;">
          <div style="font-family:var(--font-pixel);font-size:10px;margin-bottom:4px;">
            ğŸ® æŠ½çæ§åˆ¶
          </div>
          <label>éŠæˆ²æ¨¡å¼ï¼š</label>
          <select id="modeSelect" class="pixel-select">
            <option value="race">1. åƒç´ è³½è»Š (Race)</option>
            <option value="slots">2. é»ƒé‡‘æ‹‰éœ¸ (Slots)</option>
            <option value="claw">3. å¤¾å¨ƒå¨ƒæ©Ÿ (Claw)</option>
            <option value="meteor">4. æµæ˜Ÿæ’æ“Š (Meteor)</option>
            <option value="adventure">5. å†’éšªå³¶ (Adventure)</option>
            <option value="shooter">6. å¤ªç©ºå°„æ“Š (Shooter)</option>
            <option value="wheel">7. å¹¸é‹è½‰ç›¤ (Retro)</option>
            <option value="tarot">8. å¡”ç¾…ç¿»ç‰Œ (Magic)</option>
          </select>
          <label>æœ¬è¼ªè¦æŠ½å‡ºäººæ•¸ï¼ˆé€£æŠ½ï¼‰ï¼š</label>
          <input
            id="countInput"
            type="number"
            min="1"
            max="50"
            value="1"
            class="pixel-input"
          />
          <button id="startButton" class="pixel-btn">â–¶ START DRAW</button>
          <button id="resetButton" class="pixel-btn" style="background:#660000;">
            âŸ³ RESET æ´»å‹•
          </button>
          <div id="adminError" class="error-message"></div>
          <div style="margin-top:6px;" class="small">
            æŠ½çæµç¨‹ï¼šå•Ÿå‹• 5â€“8 ç§’ â†’ æ­æ›‰ 2 ç§’ â†’ æ­å–œ 5 ç§’ï¼ˆæ¯è¼ªè‡ªå‹•ä¸²æ¥ï¼‰
          </div>
        </div>
        <div class="pixel-frame status-panel">
          <h3>ğŸ‘¥ ç©å®¶åˆ—è¡¨</h3>
          <ul id="playersList"></ul>
          <h3 style="margin-top:6px;">âœ¨ å·²ä¸­ç</h3>
          <ul id="winnersList"></ul>
        </div>
      </div>
    </div>
  </div>

  <div class="layout" id="playerLayout" style="display:none;">
    <div class="player-layout">
      <div class="header">ğŸ† å®¶é˜²ä¸­å¿ƒå°¾ç‰™ç››å…¸</div>
      <div class="sub-header">æ‰‹æ©Ÿç«¯ç©å®¶å…¥å£</div>
      <div id="playerJoinPanel" class="pixel-frame" style="min-width:260px;">
        <div style="font-size:14px;margin-bottom:6px;">
          è¼¸å…¥æ‚¨çš„åç¨±ä»¥åŠ å…¥æŠ½ç
        </div>
        <input
          type="text"
          id="playerNameInput"
          class="pixel-input"
          placeholder="ç¯„ä¾‹ï¼šå°æ˜ï¼ˆç¤¾å·¥çµ„ï¼‰"
        />
        <button id="playerJoinButton" class="pixel-btn">JOIN</button>
        <div id="playerJoinError" class="error-message"></div>
        <div class="small" style="margin-top:4px;">
          è‹¥è¢«ä¸»æŒäººé‡ç½®æ´»å‹•ï¼Œç³»çµ±æœƒè‡ªå‹•ç™»å‡ºï¼Œéœ€è¦é‡æ–°åŠ å…¥ã€‚
        </div>
      </div>
      <div id="playerInfoPanel" class="pixel-frame" style="display:none;min-width:260px;">
        <div>æ‚¨çš„æŠ½çç·¨è™Ÿï¼š</div>
        <div id="playerNo" class="player-no"></div>
        <div id="playerName" class="player-name"></div>
        <div id="playerStatus" class="player-status">
          â³ å·²åŠ å…¥æŠ½çï¼Œè«‹ç­‰å¾…ä¸»æŒäººå•Ÿå‹•éŠæˆ²â€¦
        </div>
        <div id="playerWinBanner" class="win-banner" style="display:none;">
          ğŸ‰ æ­å–œä¸­çï¼ğŸ‰
        </div>
        <button id="playerLeaveButton" class="pixel-btn">
          EXIT / é‡æ–°ç™»å…¥
        </button>
      </div>
    </div>
  </div>

  <!-- Socket.io å®¢æˆ¶ç«¯ -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- å…±ç”¨å·¥å…· ---
    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    function sleep(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    const socket = io();

    // --- æ¨¡å¼åˆ‡æ› ---
    const mode = getQueryParam("mode");
    const adminLayout = document.getElementById("adminLayout");
    const playerLayout = document.getElementById("playerLayout");

    if (mode === "admin") {
      adminLayout.style.display = "block";
      setupAdmin();
    } else {
      playerLayout.style.display = "block";
      setupPlayer();
    }

    // ===========================================================
    // ç©å®¶ç«¯é‚è¼¯
    // ===========================================================
    function setupPlayer() {
      const playerNameInput = document.getElementById("playerNameInput");
      const playerJoinButton = document.getElementById("playerJoinButton");
      const playerJoinError = document.getElementById("playerJoinError");
      const playerJoinPanel = document.getElementById("playerJoinPanel");
      const playerInfoPanel = document.getElementById("playerInfoPanel");
      const playerNoEl = document.getElementById("playerNo");
      const playerNameEl = document.getElementById("playerName");
      const playerStatusEl = document.getElementById("playerStatus");
      const playerWinBanner = document.getElementById("playerWinBanner");
      const playerLeaveButton = document.getElementById("playerLeaveButton");

      let joined = false;

      function resetToJoin() {
        joined = false;
        playerJoinPanel.style.display = "block";
        playerInfoPanel.style.display = "none";
        playerJoinError.textContent = "";
        playerNameInput.value = "";
      }

      playerJoinButton.addEventListener("click", () => {
        const name = playerNameInput.value.trim();
        if (!name) {
          playerJoinError.textContent = "è«‹å…ˆè¼¸å…¥åç¨±";
          return;
        }
        playerJoinError.textContent = "é€£ç·šä¸­â€¦";

        socket.emit("join", { name }, (res) => {
          if (!res || !res.success) {
            playerJoinError.textContent =
              (res && res.message) || "åŠ å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
            return;
          }
          joined = true;
          playerJoinPanel.style.display = "none";
          playerInfoPanel.style.display = "block";
          playerJoinError.textContent = "";
          playerNoEl.textContent = res.no;
          playerNameEl.textContent = res.name;
          playerStatusEl.textContent =
            "â³ å·²åŠ å…¥æŠ½çï¼Œè«‹ç­‰å¾…ä¸»æŒäººå•Ÿå‹•éŠæˆ²â€¦";
          playerWinBanner.style.display = "none";
        });
      });

      playerLeaveButton.addEventListener("click", () => {
        resetToJoin();
      });

      // è¢«ä¸»æŒäººé‡ç½® â†’ å¼·åˆ¶ç™»å‡º
      socket.on("force-logout", () => {
        resetToJoin();
      });

      // ä¸­çå…¬å‘Šçµ¦ç©å®¶
      socket.on("you-win", (data) => {
        if (!joined) return;
        const myNo = playerNoEl.textContent;
        if (data && data.no === myNo) {
          playerStatusEl.textContent = "ğŸ‰ æ­å–œï¼æ‚¨å·²ä¸­çï¼";
          playerWinBanner.style.display = "block";
        }
      });
    }

    // ===========================================================
    // ä¸»æŒäºº / å¤§è¢å¹•ç«¯é‚è¼¯
    // ===========================================================
    function setupAdmin() {
      const modeSelect = document.getElementById("modeSelect");
      const countInput = document.getElementById("countInput");
      const startButton = document.getElementById("startButton");
      const resetButton = document.getElementById("resetButton");
      const adminError = document.getElementById("adminError");
      const playersList = document.getElementById("playersList");
      const winnersList = document.getElementById("winnersList");
      const animationArea = document.getElementById("animationArea");

      let isDrawing = false;

      startButton.addEventListener("click", async () => {
        if (isDrawing) return;
        const mode = modeSelect.value;
        const count = parseInt(countInput.value, 10) || 0;
        if (count <= 0) {
          adminError.textContent = "è«‹è¼¸å…¥è¦æŠ½å‡ºçš„äººæ•¸ï¼ˆè‡³å°‘ 1 äººï¼‰";
          return;
        }
        adminError.textContent = "";
        isDrawing = true;
        startButton.textContent = "DRAWINGâ€¦";
        try {
          await runDrawSequence({ mode, count, animationArea, adminError });
        } finally {
          isDrawing = false;
          startButton.textContent = "â–¶ START DRAW";
        }
      });

      resetButton.addEventListener("click", () => {
        if (!confirm("ç¢ºå®šè¦é‡ç½®æ•´å€‹æ´»å‹•ï¼Ÿæ‰€æœ‰ç©å®¶èˆ‡ä¸­çç´€éŒ„éƒ½æœƒæ¸…é™¤ã€‚")) {
          return;
        }
        socket.emit("reset-activity");
        adminError.textContent = "å·²é€å‡ºé‡ç½®æŒ‡ä»¤ï¼Œç©å®¶å°‡è¢«å¼·åˆ¶ç™»å‡ºã€‚";
      });

      // æ›´æ–°ç©å®¶/ä¸­çåˆ—è¡¨
      socket.on("players-updated", (data) => {
        playersList.innerHTML = "";
        winnersList.innerHTML = "";
        const players = data && data.players ? data.players : [];
        const winners = new Set(data && data.winners ? data.winners : []);

        players.forEach((p) => {
          const li = document.createElement("li");
          const isWinner = winners.has(p.no);
          li.textContent = `${p.no} - ${p.name}`;
          if (isWinner) {
            li.style.color = "#ffd700";
          }
          playersList.appendChild(li);
        });

        winners.forEach((no) => {
          const li = document.createElement("li");
          const player = players.find((p) => p.no === no);
          if (player) {
            li.textContent = `${player.no} - ${player.name}`;
          } else {
            li.textContent = no;
          }
          winnersList.appendChild(li);
        });
      });
    }

    // ===========================================================
    // æŠ½çåºåˆ—ï¼šé€£æŠ½ N äºº
    // ===========================================================
    async function runDrawSequence({ mode, count, animationArea, adminError }) {
      for (let i = 1; i <= count; i++) {
        // ç”±å¾Œç«¯æŠ½å‡ºä¸€ä½ä¸­çè€…
        const winner = await requestWinnerFromServer();
        if (!winner) {
          adminError.textContent = "å¯æŠ½ç©å®¶ä¸è¶³ï¼Œç„¡æ³•ç¹¼çºŒæŠ½çã€‚";
          break;
        }
        adminError.textContent = "";
        await runSingleAnimationRound({
          animationArea,
          mode,
          winner,
          roundIndex: i,
          roundTotal: count,
        });
      }
    }

    function requestWinnerFromServer() {
      return new Promise((resolve) => {
        socket.emit("request-winner", {}, (res) => {
          if (!res || !res.success || !res.winner) {
            resolve(null);
          } else {
            resolve(res.winner);
          }
        });
      });
    }

    // ===========================================================
    // å–®è¼ªå‹•ç•«ï¼ˆå« 8 ç¨®æ¨¡å¼ï¼‰
    // ===========================================================
    async function runSingleAnimationRound({
      animationArea,
      mode,
      winner,
      roundIndex,
      roundTotal,
    }) {
      animationArea.innerHTML = ""; // æ¸…é™¤ä¸Šä¸€è¼ª
      const root = document.createElement("div");
      root.className = "anim-root";
      animationArea.appendChild(root);

      const title = document.createElement("div");
      title.className = "anim-title";
      title.textContent = getModeTitle(mode) + ` (${roundIndex}/${roundTotal})`;
      root.appendChild(title);

      const phaseLabel = document.createElement("div");
      phaseLabel.className = "anim-phase-label";
      phaseLabel.textContent = "START";
      root.appendChild(phaseLabel);

      const winnerDisplay = document.createElement("div");
      winnerDisplay.className = "winner-display";
      winnerDisplay.innerHTML = `
        <div class="no">${winner.no}</div>
        <div class="name">${winner.name}</div>
      `;
      winnerDisplay.style.opacity = "0";
      root.appendChild(winnerDisplay);

      // å•Ÿå‹•å‹•ç•«éšæ®µï¼ˆ5â€“8 ç§’ï¼‰
      await playStartPhase(root, mode, phaseLabel);

      // æ­æ›‰ï¼ˆ2 ç§’ï¼‰
      phaseLabel.textContent = "REVEAL";
      await playRevealPhase(root, mode, winner, winnerDisplay);

      // æ­å–œå…¬å‘Šï¼ˆ5 ç§’ï¼‰
      phaseLabel.textContent = "CONGRATS";
      winnerDisplay.style.opacity = "1";
      await sleep(5000);
    }

    function getModeTitle(mode) {
      switch (mode) {
        case "race":
          return "åƒç´ è³½è»Š RACE";
        case "slots":
          return "é»ƒé‡‘æ‹‰éœ¸ SLOTS";
        case "claw":
          return "å¤¾å¨ƒå¨ƒæ©Ÿ CLAW";
        case "meteor":
          return "æµæ˜Ÿæ’æ“Š METEOR";
        case "adventure":
          return "å†’éšªå³¶ ADVENTURE";
        case "shooter":
          return "å¤ªç©ºå°„æ“Š SHOOTER";
        case "wheel":
          return "å¹¸é‹è½‰ç›¤ RETRO WHEEL";
        case "tarot":
          return "å¡”ç¾…ç¿»ç‰Œ MAGIC";
        default:
          return "LOTTERY";
      }
    }

    // ----------------- START PHASE -----------------
    async function playStartPhase(root, mode, phaseLabel) {
      phaseLabel.textContent = "START";
      switch (mode) {
        case "race":
          setupRaceScene(root, false);
          await sleep(8000);
          break;
        case "slots":
          await setupSlotsScene(root, true);
          await sleep(6000);
          break;
        case "claw":
          await setupClawScene(root, "start");
          await sleep(5000);
          break;
        case "meteor":
          await setupMeteorScene(root, "start");
          await sleep(5000);
          break;
        case "adventure":
          await setupAdventureScene(root, "start");
          await sleep(6000);
          break;
        case "shooter":
          await setupShooterScene(root, "start");
          await sleep(6000);
          break;
        case "wheel":
          await setupWheelScene(root, "start");
          await sleep(5000);
          break;
        case "tarot":
          await setupTarotScene(root, "start");
          await sleep(5000);
          break;
        default:
          await sleep(5000);
      }
    }

    // ----------------- REVEAL PHASE -----------------
    async function playRevealPhase(root, mode, winner, winnerDisplay) {
      switch (mode) {
        case "race":
          finalizeRaceScene(root, winner);
          await sleep(2000);
          break;
        case "slots":
          await finalizeSlotsScene(root, winner);
          await sleep(2000);
          break;
        case "claw":
          await setupClawScene(root, "reveal", winner);
          await sleep(2000);
          break;
        case "meteor":
          await setupMeteorScene(root, "reveal", winner);
          await sleep(2000);
          break;
        case "adventure":
          await setupAdventureScene(root, "reveal", winner);
          await sleep(2000);
          break;
        case "shooter":
          await setupShooterScene(root, "reveal", winner);
          await sleep(2000);
          break;
        case "wheel":
          await setupWheelScene(root, "reveal", winner);
          await sleep(2000);
          break;
        case "tarot":
          await setupTarotScene(root, "reveal", winner);
          await sleep(2000);
          break;
        default:
          await sleep(2000);
      }
      winnerDisplay.style.opacity = "1";
    }

    // ===========================================================
    // 1. åƒç´ è³½è»Š Raceï¼ˆä½¿ç”¨ ğŸš˜ å‰è¦–è»Šé ­ç¢ºä¿ã€Œé¢å‘å‰æ–¹ã€ï¼‰
    // ===========================================================
    function setupRaceScene(root, finalized) {
      let race = root.querySelector(".race-track");
      if (!race) {
        race = document.createElement("div");
        race.className = "race-track";
        for (let i = 0; i < 5; i++) {
          const lane = document.createElement("div");
          lane.className = "race-lane";
          const car = document.createElement("div");
          car.className = "race-car running";
          car.textContent = "ğŸš˜"; // æ­£é¢æœå‰çš„è»Šå­ emoji
          lane.appendChild(car);
          const finish = document.createElement("div");
          finish.className = "race-finish";
          lane.appendChild(finish);
          race.appendChild(lane);
        }
        root.appendChild(race);
      } else if (!finalized) {
        race.querySelectorAll(".race-car").forEach((car) => {
          car.classList.add("running");
        });
      }
    }

    function finalizeRaceScene(root, winner) {
      const race = root.querySelector(".race-track");
      if (!race) return;
      const cars = race.querySelectorAll(".race-car");
      cars.forEach((car) => {
        car.classList.remove("running");
      });
      // éš¨æ©ŸæŒ‡å®šä¸€æ¢è³½é“ç‚ºå† è»
      const winnerIndex = Math.floor(Math.random() * cars.length);
      const winnerCar = cars[winnerIndex];
      winnerCar.classList.add("winner");
      winnerCar.style.transform = "translate(70vw, -50%)";
    }

    // ===========================================================
    // 2. é»ƒé‡‘æ‹‰éœ¸ Slots
    // ===========================================================
    async function setupSlotsScene(root, spinning) {
      let container = root.querySelector(".slots-container");
      if (!container) {
        container = document.createElement("div");
        container.className = "slots-container";
        for (let i = 0; i < 3; i++) {
          const windowEl = document.createElement("div");
          windowEl.className = "slot-window";
          const strip = document.createElement("div");
          strip.className = "slot-strip";
          for (let j = 0; j < 5; j++) {
            const item = document.createElement("div");
            item.className = "slot-item";
            item.textContent = ["â­", "ğŸ’", "ğŸ’", "ğŸ””", "7ï¸âƒ£"][
              (i + j) % 5
            ];
            strip.appendChild(item);
          }
          strip.style.transform = "translateY(0px)";
          windowEl.appendChild(strip);
          container.appendChild(windowEl);
        }
        root.appendChild(container);
      }
      if (spinning) {
        const strips = container.querySelectorAll(".slot-strip");
        strips.forEach((strip, index) => {
          let offset = 0;
          const start = Date.now();
          const duration = 4000 + index * 600; // ä¾åºåœæ­¢
          function tick() {
            const now = Date.now();
            const elapsed = now - start;
            if (elapsed >= duration) return;
            offset = (offset + 16) % 200;
            strip.style.transform = `translate(-50%, ${-offset}px)`;
            requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        });
      }
    }

    async function finalizeSlotsScene(root, winner) {
      const container = root.querySelector(".slots-container");
      if (!container) return;
      const windows = container.querySelectorAll(".slot-window");
      windows.forEach((w) => {
        w.classList.add("reveal");
        const strip = w.querySelector(".slot-strip");
        strip.innerHTML = "";
      });

      if (windows.length >= 3) {
        const [w1, w2, w3] = windows;
        const s1 = w1.querySelector(".slot-strip");
        const s2 = w2.querySelector(".slot-strip");
        const s3 = w3.querySelector(".slot-strip");

        const parts = [
          winner.no.replace("No. ", "NO."),
          "-",
          winner.name,
        ];

        [s1, s2, s3].forEach((strip, idx) => {
          const item = document.createElement("div");
          item.className = "slot-item";
          item.style.fontSize = idx === 2 ? "14px" : "18px";
          item.textContent = parts[idx] || "";
          strip.appendChild(item);
          strip.style.transform = "translate(-50%, 20px)";
        });
      }
    }

    // ===========================================================
    // 3. å¤¾å¨ƒå¨ƒæ©Ÿ Claw
    // ===========================================================
    async function setupClawScene(root, phase, winner) {
      let scene = root.querySelector(".claw-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "claw-scene";
        const rail = document.createElement("div");
        rail.className = "claw-rail";
        scene.appendChild(rail);

        const head = document.createElement("div");
        head.className = "claw-head";
        head.textContent = "ğŸ‘¾";
        scene.appendChild(head);

        const toy = document.createElement("div");
        toy.className = "claw-item";
        toy.textContent = "ğŸ";
        scene.appendChild(toy);
        root.appendChild(scene);
      }
      const head = scene.querySelector(".claw-head");

      if (phase === "start") {
        head.classList.add("move-horiz");
      } else if (phase === "reveal") {
        head.classList.remove("move-horiz");
        // å‚ç›´ä¸‹é™ â†’ æŠ“å– â†’ ä¸Šå‡ â†’ æ‰è½
        await sleep(100);
        head.style.transition = "transform 0.6s ease-out";
        head.style.transform = "translate(40vw, 80px)";
        await sleep(700);
        head.style.transform = "translate(40vw, 220px)";
        await sleep(700);
        head.style.transform = "translate(40vw, 80px)";
        await sleep(700);

        const toy = scene.querySelector(".claw-item");
        toy.textContent = winner ? winner.no : "???";
        toy.style.transition = "transform 0.6s ease-out, opacity 0.6s";
        toy.style.transform = "translate(-50%, -40px)";
        await sleep(600);
        toy.style.transform = "translate(-50%, 10px)";
      }
    }

    // ===========================================================
    // 4. æµæ˜Ÿæ’æ“Š Meteor
    // ===========================================================
    async function setupMeteorScene(root, phase, winner) {
      let scene = root.querySelector(".meteor-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "meteor-scene";
        root.appendChild(scene);
      }
      if (phase === "start") {
        scene.innerHTML = "";
        const meteor = document.createElement("div");
        meteor.className = "meteor fly";
        meteor.textContent = "â˜„ï¸";
        scene.appendChild(meteor);
      } else if (phase === "reveal") {
        // ç•«é¢éœ‡å‹• + é–ƒå…‰ + é¡¯ç¤ºä¸­ç No.
        scene.classList.add("shake");
        const flash = document.createElement("div");
        flash.className = "flash";
        scene.appendChild(flash);

        const center = document.createElement("div");
        center.style.position = "absolute";
        center.style.top = "50%";
        center.style.left = "50%";
        center.style.transform = "translate(-50%, -50%)";
        center.style.fontFamily = "var(--font-pixel)";
        center.style.fontSize = "18px";
        center.textContent = winner ? winner.no : "???";
        scene.appendChild(center);
      }
    }

    // ===========================================================
    // 5. å†’éšªå³¶ Adventure
    // ===========================================================
    async function setupAdventureScene(root, phase, winner) {
      let scene = root.querySelector(".adventure-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "adventure-scene";
        const ground = document.createElement("div");
        ground.className = "adventure-ground";
        const runner = document.createElement("div");
        runner.className = "adventure-runner run";
        runner.textContent = "ğŸƒ";
        ground.appendChild(runner);

        const block = document.createElement("div");
        block.className = "adv-block";
        block.textContent = "?";
        scene.appendChild(block);

        scene.appendChild(ground);
        root.appendChild(scene);
      }
      const runner = scene.querySelector(".adventure-runner");
      const block = scene.querySelector(".adv-block");

      if (phase === "start") {
        runner.classList.add("run");
      } else if (phase === "reveal") {
        runner.classList.remove("run");
        runner.classList.add("adv-jump");
        await sleep(600);
        const prize = document.createElement("div");
        prize.className = "adv-prize";
        prize.textContent = winner ? winner.no : "???";
        scene.appendChild(prize);
      }
    }

    // ===========================================================
    // 6. å¤ªç©ºå°„æ“Š Shooter
    // ===========================================================
    async function setupShooterScene(root, phase, winner) {
      let scene = root.querySelector(".shooter-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "shooter-scene";
        const ship = document.createElement("div");
        ship.className = "shooter-ship move";
        ship.textContent = "ğŸš€";
        scene.appendChild(ship);

        const target = document.createElement("div");
        target.className = "shooter-target";
        target.textContent = "ğŸ‘¾";
        scene.appendChild(target);

        root.appendChild(scene);
      }
      const ship = scene.querySelector(".shooter-ship");
      const target = scene.querySelector(".shooter-target");

      if (phase === "start") {
        ship.classList.add("move");
      } else if (phase === "reveal") {
        ship.classList.remove("move");
        // ç™¼å°„é›·å°„
        const laser = document.createElement("div");
        laser.className = "laser fly";
        scene.appendChild(laser);
        await sleep(800);
        target.classList.add("target-hit");
        // åœ¨ target ä¸‹æ–¹é¡¯ç¤ºä¸­ç No.
        const label = document.createElement("div");
        label.style.position = "absolute";
        label.style.top = "22%";
        label.style.left = "50%";
        label.style.transform = "translateX(-50%)";
        label.style.fontFamily = "var(--font-pixel)";
        label.style.fontSize = "12px";
        label.textContent = winner ? winner.no : "???";
        scene.appendChild(label);
      }
    }

    // ===========================================================
    // 7. å¹¸é‹è½‰ç›¤ Wheel
    // ===========================================================
    async function setupWheelScene(root, phase, winner) {
      let scene = root.querySelector(".wheel-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "wheel-scene";
        const wheel = document.createElement("div");
        wheel.className = "wheel fast";
        const label = document.createElement("div");
        label.className = "wheel-label";
        label.textContent = "GOOD LUCK!";
        wheel.appendChild(label);
        scene.appendChild(wheel);

        const pointer = document.createElement("div");
        pointer.className = "pointer";
        scene.appendChild(pointer);

        root.appendChild(scene);
      }
      const wheel = scene.querySelector(".wheel");
      const label = scene.querySelector(".wheel-label");

      if (phase === "start") {
        wheel.classList.remove("slow");
        wheel.classList.add("fast");
        label.textContent = "SPINNING...";
      } else if (phase === "reveal") {
        wheel.classList.remove("fast");
        wheel.classList.add("slow");
        label.textContent = winner ? winner.no : "WINNER";
      }
    }

    // ===========================================================
    // 8. å¡”ç¾…ç¿»ç‰Œ Tarot
    // ===========================================================
    async function setupTarotScene(root, phase, winner) {
      let scene = root.querySelector(".tarot-scene");
      if (!scene) {
        scene = document.createElement("div");
        scene.className = "tarot-scene";
        for (let i = 0; i < 3; i++) {
          const card = document.createElement("div");
          card.className = "tarot-card";
          const back = document.createElement("div");
          back.className = "tarot-card-face tarot-back";
          back.textContent = "â˜…";
          const front = document.createElement("div");
          front.className = "tarot-card-face tarot-front";
          front.innerHTML = "<div>WIN</div>";
          card.appendChild(back);
          card.appendChild(front);
          scene.appendChild(card);
        }
        root.appendChild(scene);
      }
      const cards = scene.querySelectorAll(".tarot-card");
      if (phase === "start") {
        cards.forEach((c, idx) => {
          if (idx === 1) c.classList.add("shuffle");
        });
      } else if (phase === "reveal") {
        cards.forEach((c) => c.classList.remove("shuffle"));
        const target = cards[1];
        target.classList.add("flip");
        const front = target.querySelector(".tarot-front");
        front.innerHTML = `<div>${winner ? winner.no : "???"}</div><div style="margin-top:4px;font-size:8px;">${winner ? winner.name : ""}</div>`;
      }
    }
  </script>
</body>
</html>
