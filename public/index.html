<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES LUCKY DRAW</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    
    <!-- ÂºïÂÖ•ÂÉèÁ¥†È¢®Ê†ºÂ≠óÈ´î -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Á¥ÖÁôΩÊ©üÁ∂ìÂÖ∏ÈÖçËâ≤ */
            --nes-red: #E60012;
            --nes-white: #FFFFFF;
            --nes-black: #000000;
            --nes-gold: #F8B800;
            --nes-blue: #5C94FC; /* Á∂ìÂÖ∏Â§©Á©∫Ëóç */
            --nes-ground: #C84C0C; /* Âú∞ÊùøÁ£öÂ°äËâ≤ */
            
            --text-main: #FFFFFF;
        }

        body {
            font-family: 'Press Start 2P', 'Noto Sans TC', cursive;
            background-color: var(--nes-blue); /* ËÉåÊôØÊîπÁÇ∫Á∂ìÂÖ∏Â§©Á©∫Ëóç */
            color: var-text-main;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-transform: uppercase;
            image-rendering: pixelated; /* Âº∑Âà∂ÂÉèÁ¥†ÂåñÊ∏≤Êüì */
        }

        /* --- 1. Âæ©Âè§ 8-bit ËÉåÊôØ (CSS Áπ™Ë£Ω) --- */
        .nes-background {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0;
            overflow: hidden;
        }

        /* ÂÉèÁ¥†Èõ≤Êúµ (CSS Box Shadow Art) */
        .pixel-cloud {
            position: absolute;
            width: 4px; height: 4px;
            background: transparent;
            color: #fff;
            box-shadow: 
                20px 0, 24px 0, 28px 0, 32px 0,
                16px 4px, 36px 4px,
                12px 8px, 40px 8px,
                8px 12px, 44px 12px,
                4px 16px, 48px 16px,
                8px 20px, 44px 20px,
                12px 24px, 40px 24px,
                16px 28px, 36px 28px,
                20px 32px, 24px 32px, 28px 32px, 32px 32px;
            transform: scale(4); /* ÊîæÂ§ß */
            opacity: 0.8;
            animation: cloud-move linear infinite;
        }

        @keyframes cloud-move {
            from { left: -200px; }
            to { left: 110%; }
        }

        /* Âú∞ÊùøÁ£öÂ°ä */
        .ground-floor {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 60px;
            background-image: 
                linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px),
                linear-gradient(335deg, rgba(0,0,0,0.3) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.3) 23px, transparent 23px);
            background-color: var(--nes-ground);
            background-size: 58px 58px;
            border-top: 4px solid #000;
            z-index: 1;
        }

        /* ÈÅ†ÊôØÂ±±ËÑà (CSS) */
        .mountains {
            position: absolute;
            bottom: 60px; left: 0; width: 100%; height: 200px;
            background: 
                linear-gradient(135deg, #00A800 25%, transparent 25%) -50px 0,
                linear-gradient(225deg, #00A800 25%, transparent 25%) -50px 0,
                linear-gradient(315deg, #00A800 25%, transparent 25%),
                linear-gradient(45deg, #00A800 25%, transparent 25%);
            background-size: 100px 100px;
            opacity: 0.8;
        }

        /* --- UI Â±§ (NES ÈÇäÊ°ÜÈ¢®Ê†º) --- */
        #login-page, #game-page, #winner-modal {
            position: relative; z-index: 10;
            width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* ÈÄöÁî® NES ÈÇäÊ°Ü (ÈªëÁôΩÈõôÂ±§) */
        .nes-box {
            background: var(--nes-black);
            color: #fff;
            padding: 20px;
            position: relative;
            /* Ê®°Êì¨ÂÉèÁ¥†ÈÇäÊ°Ü */
            box-shadow:
                -4px 0 0 0 #fff,
                4px 0 0 0 #fff,
                0 -4px 0 0 #fff,
                0 4px 0 0 #fff,
                -4px -4px 0 0 #fff,
                4px 4px 0 0 #fff,
                4px -4px 0 0 #fff,
                -4px 4px 0 0 #fff,
                0 0 0 4px #000; /* Â§ñÈªëÊ°Ü */
            margin: 10px;
        }

        /* --- 2. QR Code ÁôªÂÖ•È†Å --- */
        #login-page { transition: opacity 0.5s; justify-content: flex-start; padding-top: 50px; }
        
        .login-header {
            display: flex; align-items: center; gap: 30px; margin-bottom: 20px;
            background: var(--nes-black); padding: 30px;
            border: 4px solid #fff; /* Á∞°ÂñÆÁ≤óÊö¥ÁöÑÁôΩÊ°Ü */
        }

        .qr-box img {
            display: block; width: 140px; height: 140px; image-rendering: pixelated;
            border: 4px solid var-nes-white;
        }

        .qr-title {
            color: var(--nes-white); font-size: 1.5rem; margin-bottom: 15px; line-height: 1.5;
            text-shadow: 4px 4px 0 var(--nes-red); /* Á¥ÖËâ≤Èô∞ÂΩ± */
        }

        .join-counter { font-size: 1rem; color: #aaa; margin: 10px 0; font-family: 'Noto Sans TC'; }
        .join-number {
            font-size: 2rem; color: var(--nes-gold); font-family: 'Press Start 2P';
            margin-left: 10px; text-shadow: 2px 2px 0 #000;
        }

        /* NES ÊåâÈàï */
        .btn-retro {
            font-family: 'Press Start 2P', cursive;
            background: var(--nes-red); color: #fff; border: 4px solid #fff;
            padding: 15px 25px; font-size: 1rem; cursor: pointer;
            box-shadow: 4px 4px 0px 0px #000;
            position: relative; margin: 5px; transition: transform 0.1s;
        }
        .btn-retro:active { transform: translate(4px, 4px); box-shadow: none; }
        .btn-retro:disabled { background: #555; color: #aaa; border-color: #aaa; cursor: not-allowed; }
        .btn-blue { background: #0000AA; } /* Á∂ìÂÖ∏Ê∑±Ëóç */
        .btn-green { background: #008800; }

        /* --- Áé©ÂÆ∂Á∂≤Ê†º --- */
        .player-grid-container {
            width: 90%; max-width: 1000px; flex: 1; overflow-y: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px; align-content: start;
            margin-bottom: 80px; /* ÈÅøÈñãÂú∞Êùø */
        }
        .player-slot {
            background: #000; border: 4px solid #fff;
            aspect-ratio: 1 / 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.5);
            animation: slot-pop 0.3s steps(2) forwards;
        }
        @keyframes slot-pop { from { transform: scale(0); } to { transform: scale(1); } }
        .player-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .player-name { font-size: 0.6rem; color: #fff; text-align: center; word-break: break-all; }

        /* --- 3. ÊäΩÁçé‰∏ªÁï´Èù¢ --- */
        #game-page { display: none; opacity: 0; }
        #game-page.active { display: flex; opacity: 1; }

        .stage-container { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; position: relative; z-index: 5; }
        
        .slot-machine-frame {
            width: 80%; max-width: 800px; height: 400px;
            background: #000; 
            border: 8px solid var(--nes-white); /* Á≤óÁôΩÊ°Ü */
            box-shadow: 10px 10px 0 #000; /* Á°¨Èô∞ÂΩ± */
            position: relative;
        }
        
        #game-canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        .control-panel {
            width: 100%; background: #000; padding: 20px;
            display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 20; 
            border-top: 4px solid #fff;
            flex-wrap: wrap;
        }

        .input-group { 
            display: flex; align-items: center; gap: 10px; 
            background: #000; padding: 5px 10px; border: 4px solid #fff;
            color: #fff; font-size: 0.8rem;
        }
        input[type="number"] { 
            background: transparent; border: none; color: var(--nes-gold);
            font-size: 1rem; width: 60px; text-align: center; outline: none; 
            font-family: 'Press Start 2P';
        }

        /* --- 4. ÂæóÁçéÂΩàÁ™ó (LEVEL CLEAR) --- */
        #winner-modal {
            background: rgba(0,0,0,0.8);
            display: none; opacity: 0; transition: opacity 0.3s;
        }
        #winner-modal.active { display: flex; opacity: 1; }
        
        .winner-card {
            display: flex; flex-direction: column; align-items: center;
            position: relative; z-index: 10;
            background: #000;
            padding: 40px;
            border: 8px solid var(--nes-gold);
            box-shadow: 10px 10px 0 #000;
        }
        
        .winner-title {
            font-size: 2rem; color: var(--nes-gold); margin-bottom: 20px;
            text-shadow: 4px 4px 0 #b71c1c;
            animation: blink 0.5s infinite;
        }

        .winner-name-big { 
            font-size: 3.5rem; color: #fff; margin: 20px 0;
            text-shadow: 4px 4px 0 var(--nes-blue);
            white-space: nowrap; 
        }

        /* --- ÁÆ°ÁêÜÂΩàÁ™ó --- */
        #manage-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        #manage-modal.active { display: flex; }
        .manage-box { 
            background: #000; padding: 20px; width: 90%; max-width: 600px; height: 70vh; 
            display: flex; flex-direction: column; border: 4px solid #fff; color: #fff;
        }
        .user-list-container { flex: 1; overflow-y: auto; background: #000; margin: 15px 0; border: 2px solid #fff; padding: 10px; font-family: 'Noto Sans TC'; }
        .user-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 2px dashed #333; color: #fff; align-items: center; }
        .excluded-text { text-decoration: line-through; color: #666; }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>

    <!-- 0. Âæ©Âè§ NES ËÉåÊôØÂ±§ -->
    <div class="nes-background">
        <!-- ÂπæÊúµÂÉèÁ¥†Èõ≤ -->
        <div class="pixel-cloud" style="top: 10%; animation-duration: 20s;"></div>
        <div class="pixel-cloud" style="top: 25%; animation-duration: 25s; transform: scale(3); opacity: 0.6;"></div>
        <div class="pixel-cloud" style="top: 15%; animation-duration: 18s; transform: scale(5); opacity: 0.4;"></div>
        
        <div class="mountains"></div>
        <div class="ground-floor"></div>
    </div>

    <!-- 1. ÁôªÂÖ•Áï´Èù¢ (Select Player) -->
    <div id="login-page">
        <!-- ‰∏äÊñπË≥áË®äÊ¨Ñ -->
        <div class="login-header nes-box">
            <div style="text-align:center;">
                <div class="qr-box">
                    <img id="qr-img" src="" alt="QR">
                </div>
                <div style="font-size:0.6rem; color:#fff; margin-top:10px;">SCAN TO START</div>
            </div>
            <div class="login-info">
                <div class="qr-title">PLAYER SELECT</div>
                <div class="join-counter">
                    P1 READY: <span id="join-count" class="join-number">0</span>
                </div>
                <button class="btn-retro btn-blue" onclick="enterGame()">PRESS START</button>
            </div>
        </div>

        <!-- Áé©ÂÆ∂Á∂≤Ê†º -->
        <div class="player-grid-container" id="player-grid"></div>
    </div>

    <!-- 2. ÈÅäÊà≤‰∏ªÊéßÂè∞ -->
    <div id="game-page">
        <div class="stage-container">
            <div class="slot-machine-frame">
                <canvas id="game-canvas"></canvas>
            </div>
        </div>
        <div class="control-panel">
            <button id="draw-btn" class="btn-retro" onclick="startMultiDraw()">SPIN!</button>
            <div class="input-group">
                <label>COUNT:</label>
                <input type="number" id="draw-count" value="1" min="1" max="50">
            </div>
            <button class="btn-retro btn-green" onclick="toggleMusic()" id="music-btn">SOUND: ON</button>
            <button class="btn-retro" onclick="openManageModal()">PLAYERS</button>
            <button class="btn-retro" style="background:#555;" onclick="resetEvent()">RESET</button>
            
            <div style="width: 100%; text-align: center; margin-top: 10px; color: var(--nes-gold); font-size: 0.8rem;">
                CREDITS: <span id="game-join-count">0</span>
            </div>
        </div>
    </div>

    <!-- 3. ÂæóÁçéÂΩàÁ™ó -->
    <div id="winner-modal" onclick="closeWinnerModal()">
        <div class="winner-card" onclick="event.stopPropagation()">
            <div class="winner-title">YOU WIN!</div>
            
            <!-- Lottie Êí≠ÊîæÂô® -->
            <lottie-player id="winner-lottie"
                background="transparent" 
                speed="1" 
                style="width: 400px; height: 400px;" 
                loop 
                autoplay>
            </lottie-player>

            <div class="winner-name-big" id="modal-winner-name">WINNER</div>
            <div style="margin-top:20px;">
                <button class="btn-retro btn-blue" onclick="closeWinnerModal()">NEXT ROUND</button>
            </div>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÂΩàÁ™ó -->
    <div id="manage-modal" onclick="closeManageModal()">
        <div class="manage-box" onclick="event.stopPropagation()">
            <h3 style="color:var(--nes-yellow); margin-bottom:10px;">ROSTER</h3>
            <div class="user-list-container" id="manage-list"></div>
            <div style="text-align:right;">
                <button class="btn-retro" onclick="closeManageModal()">EXIT</button>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        const socket = io();
        let users = [];
        let winners = []; 
        let localExcluded = new Set();
        let isDrawing = false;
        let animState = 'idle'; 
        let scrollY = 0;

        const bgmAudio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg'); 
        bgmAudio.loop = true;
        bgmAudio.volume = 0.3;
        let isMusicOn = true;

        const winnerAnimations = [
            "Emos Spin.json",
            "Monitor screen with video game level up.json",
            "Cat fishing on moon.json",
            "Generator.json",
            "Target.json",
            "Super Mario.json",
            "football Goal.json",
            "Formula One.json"
        ];

        // Âæ©Âè§ÂúñÁ§∫
        const retroIcons = ["üëæ", "üïπÔ∏è", "üöÄ", "üíé", "ü§ñ", "üëΩ", "üëª", "üí£", "üìÄ", "üíæ", "üéÆ", "üîã", "‚ö°", "üî•", "üçÑ", "‚≠ê"];

        const loginPage = document.getElementById('login-page');
        const gamePage = document.getElementById('game-page');
        const joinCountEl = document.getElementById('join-count');
        const gameJoinCountEl = document.getElementById('game-join-count');
        const winnerModal = document.getElementById('winner-modal');
        const modalWinnerName = document.getElementById('modal-winner-name');
        const drawBtn = document.getElementById('draw-btn');
        const winnerLottiePlayer = document.getElementById('winner-lottie');
        const playerGridEl = document.getElementById('player-grid');

        const mobileUrl = window.location.origin + "/mobile.html";
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(mobileUrl)}`;

        socket.on('connect', () => { socket.emit('admin_init'); });
        
        socket.on('update_user_list', (u) => { 
            users = u; 
            updateCounters(); 
            renderPlayerGrid(); 
            if(document.getElementById('manage-modal').classList.contains('active')) renderManageList();
        });
        
        socket.on('update_winners', (w) => { winners = w; });
        socket.on('draw_result', (data) => {
            winners.push(data.winnerName);
            stopRollingAndShowWinner(data.winnerName);
        });
        socket.on('admin_draw_error', (msg) => { alert(msg); isDrawing=false; resetUI(); });
        socket.on('event_reset', () => location.reload());

        function toggleMusic() {
            isMusicOn = !isMusicOn;
            document.getElementById('music-btn').textContent = isMusicOn ? "SOUND: ON" : "SOUND: OFF";
            if (!isMusicOn) bgmAudio.pause();
            else if(!isDrawing) bgmAudio.play().catch(()=>{});
        }

        function renderPlayerGrid() {
            playerGridEl.innerHTML = '';
            users.forEach((user, index) => {
                const slot = document.createElement('div');
                slot.className = 'player-slot';
                const icon = retroIcons[index % retroIcons.length]; 
                slot.innerHTML = `<div class="player-icon">${icon}</div><div class="player-name">${user}</div>`;
                playerGridEl.appendChild(slot);
            });
        }

        let modalResolver = null;
        async function startMultiDraw() {
            const validCount = users.filter(u => !winners.includes(u) && !localExcluded.has(u)).length;
            if(validCount === 0) { alert("NO PLAYERS!"); return; }
            if(isDrawing) return;
            
            const count = parseInt(document.getElementById('draw-count').value) || 1;
            
            isDrawing=true; drawBtn.disabled=true;
            if(isMusicOn) bgmAudio.pause();

            for(let i=0; i<count; i++) {
                drawBtn.textContent = `DRAW (${i+1}/${count})`;
                await new Promise(resolve => {
                    socket.emit('admin_start_rolling');
                    startRollingAnim();
                    setTimeout(() => { socket.emit('admin_perform_draw'); resolve(); }, 3500);
                });
                await new Promise(r => modalResolver = r); 
                await new Promise(r => setTimeout(r, 500));
            }
            resetUI();
            speak("ÊäΩÁçéÁµêÊùü");
        }

        function resetUI() { 
            isDrawing=false; drawBtn.disabled=false; drawBtn.textContent="SPIN!"; animState='idle';
            if(isMusicOn) bgmAudio.play().catch(()=>{});
        }
        function resetEvent() { if(confirm("RESET GAME?")) socket.emit('admin_reset'); }

        function stopRollingAndShowWinner(name) {
            animState='idle'; modalWinnerName.textContent=name;
            const randomAnim = winnerAnimations[Math.floor(Math.random() * winnerAnimations.length)];
            winnerLottiePlayer.load(randomAnim);

            winnerModal.classList.add('active');
            if(isMusicOn) bgmAudio.play().catch(()=>{});
            playWinSound(); speak("ÊÅ≠Âñú "+name); fireConfetti();
        }
        function closeWinnerModal() {
            winnerModal.classList.remove('active');
            if(modalResolver) { modalResolver(); modalResolver=null; } else { resetUI(); }
        }

        // Canvas (Pixel Art Style)
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        function initGameVisuals() { resizeCanvas(); window.addEventListener('resize', resizeCanvas); drawLoop(); }
        function resizeCanvas() { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; }
        
        function drawLoop() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            const cx=canvas.width/2; const cy=canvas.height/2;
            const validUsers = users.filter(u => !winners.includes(u) && !localExcluded.has(u));
            const displayList = validUsers.length > 0 ? validUsers : ["INSERT COIN"];

            ctx.font = '30px "Press Start 2P"';
            ctx.textAlign='center'; ctx.textBaseline='middle';

            if(animState==='idle') {
                const t=Date.now()*0.002;
                for(let i=0; i<3; i++){
                    const idx = (Math.floor(t)+i)%displayList.length;
                    const yOff = Math.sin(t+i)*40;
                    ctx.fillStyle = `rgba(255, 255, 255, ${0.5 + Math.sin(t+i)*0.3})`;
                    if(displayList[idx]) ctx.fillText(displayList[idx], cx, cy+(i-1)*60+yOff);
                }
            } else if(animState==='rolling') {
                scrollY+=80;
                const itemH=100;
                ctx.font = '40px "Press Start 2P"';
                for(let i=-2; i<=2; i++){
                    const idx=Math.floor(scrollY/itemH)+i;
                    const safeIdx=((idx%displayList.length)+displayList.length)%displayList.length;
                    const y=cy+(i*itemH)+(scrollY%itemH);
                    ctx.fillStyle = (i===0) ? '#ff0055' : '#00f2ff';
                    if(displayList[safeIdx]) ctx.fillText(displayList[safeIdx], cx, y);
                }
            }
            requestAnimationFrame(drawLoop);
        }

        function startRollingAnim() {
            animState='rolling'; let d=3500; let s=Date.now();
            const loop=()=>{
                if(animState!=='rolling') return;
                let p=(Date.now()-s)/d;
                if(p<1){ playTick(150 + p*300); setTimeout(loop, Math.max(50, 100*(1-p*0.8))); }
            }; loop();
        }

        function openManageModal(){ document.getElementById('manage-modal').classList.add('active'); renderManageList(); }
        function closeManageModal(){ document.getElementById('manage-modal').classList.remove('active'); }
        function renderManageList(){
            const el=document.getElementById('manage-list'); el.innerHTML='';
            if(users.length===0) { el.innerHTML='<div style="padding:20px;text-align:center;">EMPTY</div>'; return; }
            users.forEach(u=>{
                const isEx=localExcluded.has(u); const isWon=winners.includes(u);
                const row=document.createElement('div'); row.className='user-row';
                let btnHtml = `<button class="btn-retro" style="font-size:0.6rem; padding:5px 10px; background:${isEx?'#333':'#c62828'}" onclick="toggleEx('${u}')">${isEx?'RESTORE':'KICK'}</button>`;
                if(isWon) btnHtml = `<span style="color:#ffee00">WINNER</span>`;
                row.innerHTML=`<span class="${isEx?'excluded-text':''}">${u}</span>${btnHtml}`;
                el.appendChild(row);
            });
        }
        function toggleEx(n){ if(localExcluded.has(n)) localExcluded.delete(n); else localExcluded.add(n); socket.emit('admin_toggle_exclude',n); renderManageList(); }

        function updateCounters(){ joinCountEl.textContent=users.length; gameJoinCountEl.textContent=users.length; }
        function enterGame(){ 
            loginPage.style.opacity='0'; 
            setTimeout(() => {
                loginPage.style.display='none'; 
                gamePage.classList.add('active'); 
                initAudio(); 
                initGameVisuals(); 
                if(isMusicOn) bgmAudio.play().catch(()=>{});
            }, 800);
        }
        
        let ac; function initAudio(){ if(!ac) ac=new (window.AudioContext||window.webkitAudioContext)(); }
        function playTick(p){ 
            if(!ac)return; const o=ac.createOscillator(),g=ac.createGain(); 
            o.type='square'; o.frequency.value=p; g.gain.setValueAtTime(0.1,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ac.currentTime+0.05); 
            o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+0.06); 
        }
        function playWinSound(){ 
            if(!ac)return; const n=ac.currentTime; 
            [440, 554, 659, 880, 440, 554, 659, 880].forEach((f,i)=>{ 
                const o=ac.createOscillator(),g=ac.createGain(); 
                o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1,n+i*0.1); g.gain.exponentialRampToValueAtTime(0.01,n+i*0.1+0.1); 
                o.connect(g); g.connect(ac.destination); o.start(n+i*0.1); o.stop(n+i*0.1+0.1); 
            }); 
        }
        function speak(t){ window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='zh-TW'; window.speechSynthesis.speak(u); }
        
        const cf=document.getElementById('confetti-canvas'), cfx=cf.getContext('2d'); let ps=[];
        function fireConfetti(){ 
            cf.width=window.innerWidth; cf.height=window.innerHeight; ps=[]; 
            for(let i=0;i<100;i++) ps.push({
                x:cf.width/2, y:cf.height/2, vx:(Math.random()-0.5)*30, vy:(Math.random()-0.5)*30-10, 
                size: Math.random()*10+5, c:`hsl(${Math.random()*360},100%,50%)`
            }); 
            upCf(); 
        }
        function upCf(){ 
            cfx.clearRect(0,0,cf.width,cf.height); 
            ps.forEach((p,i)=>{ 
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; 
                if(p.y > cf.height) ps.splice(i,1);
                cfx.fillStyle=p.c; cfx.fillRect(p.x,p.y,p.size,p.size); 
            }); 
            if(ps.length) requestAnimationFrame(upCf); 
        }
    </script>
</body>
</html>
