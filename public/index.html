<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NES TV DRAW</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --nes-blue: #5C94FC;
            --nes-ground: #C84C0C;
            --text-white: #FFFFFF;
            --text-gold: #FFD700;
            --tv-gray: #2b2b2b;
            --tv-dark: #1a1a1a;
        }

        body {
            font-family: 'Press Start 2P', 'Noto Sans TC', monospace;
            background-color: var(--nes-blue);
            color: var(--text-white);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            image-rendering: pixelated;
            user-select: none;
        }

        /* --- ËÉåÊôØ (Super Mario Style) --- */
        .game-world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden;
        }
        
        .pixel-cloud {
            position: absolute; background: #fff; width: 60px; height: 20px;
            box-shadow: 20px 0 #fff, 10px -20px #fff;
            opacity: 0.8; animation: drift linear infinite;
        }
        @keyframes drift { from { left: -100px; } to { left: 110%; } }

        .ground-layer {
            position: absolute; bottom: 0; width: 100%; height: 60px;
            background: 
                repeating-linear-gradient(90deg, #000 0, #000 2px, transparent 2px, transparent 40px),
                repeating-linear-gradient(0deg, #000 0, #000 2px, #C84C0C 2px, #C84C0C 40px);
            background-color: #C84C0C;
            border-top: 4px solid #000;
        }

        /* --- UI ÈÄöÁî® --- */
        #login-page, #game-page {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 1. ÁôªÂÖ•È†Å --- */
        #login-page { padding-top: 40px; transition: opacity 0.5s; justify-content: flex-start; }

        .header-panel {
            background: rgba(0,0,0,0.8);
            border: 4px solid #fff;
            padding: 20px 40px;
            display: flex; gap: 30px; align-items: center;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }

        .qr-frame { background: #fff; padding: 5px; border: 4px solid #000; }
        #qr-img { width: 120px; height: 120px; display: block; image-rendering: pixelated; }

        .info-block { text-align: left; }
        .scan-text { color: #ffffff; font-size: 1.2rem; margin-bottom: 10px; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }

        .player-count-label { color: var(--text-gold); font-size: 0.8rem; margin-top: 10px; }
        .player-count-num { font-size: 1.5rem; color: #fff; text-shadow: 2px 2px #000; }

        .btn-start {
            margin-top: 15px; padding: 10px 20px; font-family: inherit; font-size: 1rem;
            background: #E60012; color: #fff; border: 4px solid #fff; cursor: pointer;
            box-shadow: 4px 4px 0 #000;
        }
        .btn-start:active { transform: translate(4px, 4px); box-shadow: none; }

        /* Áé©ÂÆ∂Á∂≤Ê†º */
        .player-grid {
            width: 90%; max-width: 1200px; flex: 1; 
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 15px;
            overflow-y: auto; padding: 10px; margin-bottom: 70px;
        }
        
        .char-box {
            width: 100px; height: 100px;
            background: #000; border: 4px solid #fff;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.4);
            animation: spawn 0.3s forwards; transform: scale(0);
        }
        @keyframes spawn { to { transform: scale(1); } }
        
        .char-icon { font-size: 2.5rem; margin-bottom: 5px; animation: jump 1s infinite; }
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .char-name { font-size: 0.6rem; color: #fff; text-align: center; word-break: break-all; font-family: 'Noto Sans TC'; }

        /* --- 2. ÊäΩÁçé‰∏ªÁï´Èù¢ (ÈõªË¶ñÊ©ü) --- */
        #game-page { display: none; opacity: 0; justify-content: center; }
        #game-page.active { display: flex; opacity: 1; }

        .machine-container { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; }
        
        /* ‚òÖ‚òÖ‚òÖ Âæ©Âè§ÈõªË¶ñÊ©üÂ§ñÊ°Ü ‚òÖ‚òÖ‚òÖ */
        .tv-frame {
            width: 85%; max-width: 900px; height: 500px;
            background-color: var(--tv-gray);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.8), /* ÂÖßÈÉ®Èô∞ÂΩ± */
                10px 10px 0 rgba(0,0,0,0.5), /* Â§ñÈÉ®Á°¨Èô∞ÂΩ± */
                inset 2px 2px 5px rgba(255,255,255,0.2); /* ‰∫ÆÈÇä */
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* ÈõªË¶ñÂìÅÁâåÊ®ôÁ±§ */
        .tv-brand {
            position: absolute; bottom: 15px; right: 40px;
            font-size: 0.8rem; color: #888; font-style: italic; letter-spacing: 2px;
        }

        /* Ë£ùÈ£æÁ∑öÊ¢ù/ÂñáÂè≠Â≠î */
        .tv-speaker {
            position: absolute; bottom: 20px; left: 40px;
            width: 100px; height: 10px;
            background: repeating-linear-gradient(90deg, #111 0, #111 2px, transparent 2px, transparent 6px);
        }

        /* Ëû¢ÂπïÂçÄÂüü */
        .screen-area {
            width: 100%; height: 100%;
            background-color: #000;
            border-radius: 50% 50% 50% 50% / 5% 5% 5% 5%; /* Ê®°Êì¨Êò†ÂÉèÁÆ°ÂúìÂºß */
            position: relative;
            overflow: hidden;
            border: 4px solid #111;
            box-shadow: inset 0 0 20px #000;
        }

        /* Ëû¢ÂπïÊéÉÊèèÁ∑ö & ÂèçÂÖâ */
        .screen-area::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: 
                linear-gradient(rgba(255,255,255,0.05) 50%, transparent 50%),
                linear-gradient(90deg, rgba(255,0,0,0.03), rgba(0,255,0,0.01), rgba(0,0,255,0.03));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none; z-index: 20;
        }

        /* ÂÖßÂÆπÂ±§ */
        #game-canvas { position: absolute; top:0; left:0; width: 100%; height: 100%; z-index: 5; image-rendering: pixelated; }
        
        #tv-lottie-player {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; display: none; background: #000;
        }

        /* ÊéßÂà∂Âè∞ */
        .control-bar {
            width: 100%; background: #222; padding: 20px;
            display: flex; justify-content: center; gap: 20px; align-items: center;
            border-top: 4px solid #fff; z-index: 20; flex-wrap: wrap;
        }
        
        .nes-input-group { display: flex; align-items: center; gap: 10px; color: var(--text-gold); font-size: 0.8rem; }
        .nes-input { background: #000; border: 2px solid #fff; color: #fff; font-family: inherit; font-size: 1rem; width: 60px; text-align: center; outline: none; }
        .credits-text { width: 100%; text-align: center; color: var(--text-gold); margin-top: 10px; font-size: 0.8rem; text-shadow: 2px 2px 0 #000; }

        /* --- 3. ‰∏≠ÁçéÂΩàÁ™ó --- */
        #winner-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #winner-modal.active { display: flex; }

        .winner-panel {
            background: #000; border: 8px solid var(--text-gold);
            padding: 40px; text-align: center; position: relative;
            box-shadow: 0 0 0 100vh rgba(0,0,0,0.5);
            animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes zoomIn { from { transform: scale(0); } to { transform: scale(1); } }

        .winner-header { color: var(--text-gold); font-size: 2rem; margin-bottom: 20px; animation: flash 0.2s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }

        .winner-name { font-size: 4rem; color: #fff; margin: 20px 0; text-shadow: 4px 4px #E60012; }

        /* --- ÁÆ°ÁêÜÂΩàÁ™ó --- */
        #manage-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: none; align-items: center; justify-content: center; }
        #manage-modal.active { display: flex; }
        .manage-box { width: 80%; max-width: 600px; height: 70vh; background: #000; border: 4px solid #fff; display: flex; flex-direction: column; padding: 20px; color: #fff; }
        .manage-list { flex: 1; overflow-y: auto; border: 2px solid #333; margin: 15px 0; font-family: 'Noto Sans TC'; }
        .manage-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #555; }
        .excluded { text-decoration: line-through; color: #666; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>

    <div class="game-world">
        <div class="pixel-cloud" style="top: 10%; animation-duration: 20s;"></div>
        <div class="pixel-cloud" style="top: 30%; animation-duration: 35s; transform: scale(1.5);"></div>
        <div class="ground-layer"></div>
    </div>

    <!-- 1. ÁôªÂÖ•È†Å -->
    <div id="login-page">
        <div class="header-panel">
            <div style="text-align: center;">
                <div class="qr-frame"><img id="qr-img" src="" alt="QR"></div>
            </div>
            <div class="info-block">
                <div class="scan-text">SCAN TO JOIN</div>
                <div class="player-count-label">PLAYERS READY</div>
                <div class="player-count-num" id="join-count">00</div>
                <button class="btn-start" onclick="enterGame()">START GAME</button>
            </div>
        </div>
        <div class="player-grid" id="player-grid"></div>
    </div>

    <!-- 2. ÈÅäÊà≤‰∏ªÁï´Èù¢ -->
    <div id="game-page">
        <div class="machine-container">
            <!-- ‚òÖ‚òÖ‚òÖ ÈõªË¶ñÊ©üÁµêÊßã ‚òÖ‚òÖ‚òÖ -->
            <div class="tv-frame">
                <div class="screen-area">
                    <!-- 1. ÂÉèÁ¥†ÊñáÂ≠ó Canvas (ÂæÖÊ©üÁî®) -->
                    <canvas id="game-canvas"></canvas>
                    
                    <!-- 2. Lottie ÂãïÁï´Â±§ (ÊäΩÁçé/‰∏≠ÁçéÁî®) -->
                    <lottie-player id="tv-lottie-player"
                        background="#000" speed="1" loop autoplay>
                    </lottie-player>
                </div>
                
                <div class="tv-brand">NES-TV 1985</div>
                <div class="tv-speaker"></div>
            </div>
        </div>

        <div class="control-bar">
            <button class="btn-start" id="draw-btn" onclick="startMultiDraw()">SPIN</button>
            <div class="nes-input-group">
                <label>COUNT:</label>
                <input type="number" class="nes-input" id="draw-count" value="1" min="1" max="50">
            </div>
            <button class="btn-start" style="background:#008800;" onclick="toggleMusic()" id="music-btn">MUSIC: ON</button>
            <button class="btn-start" style="background:#0000AA;" onclick="openManageModal()">ROSTER</button>
            <button class="btn-start" style="background:#333;" onclick="resetEvent()">RESET</button>
            <div class="credits-text">CREDITS: <span id="game-join-count">0</span></div>
        </div>
    </div>

    <!-- 3. ‰∏≠ÁçéÂΩàÁ™ó -->
    <div id="winner-modal" onclick="closeWinnerModal()">
        <div class="winner-panel" onclick="event.stopPropagation()">
            <div class="winner-header">‚òÖ WINNER! ‚òÖ</div>
            <div class="winner-name" id="modal-winner-name">NAME</div>
            <button class="btn-start" style="background:#0000AA;" onclick="closeWinnerModal()">CONTINUE</button>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÂΩàÁ™ó -->
    <div id="manage-modal" onclick="closeManageModal()">
        <div class="manage-box" onclick="event.stopPropagation()">
            <div style="color:var(--text-gold); text-align:center;">PLAYER LIST</div>
            <div class="manage-list" id="manage-list"></div>
            <div style="text-align:right;">
                <button class="btn-start" onclick="closeManageModal()">OK</button>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        const socket = io();
        let users = [];
        let winners = [];
        let localExcluded = new Set();
        let isDrawing = false;
        let animState = 'idle';
        let scrollY = 0;

        // BGM
        const bgmAudio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg'); 
        bgmAudio.loop = true; bgmAudio.volume = 0.3;
        let isMusicOn = true;

        // ‚òÖ‚òÖ‚òÖ Lottie Ë≥áÊ∫êÂÆöÁæ© ‚òÖ‚òÖ‚òÖ
        const rollingAnimFile = "Emos Spin.json"; // ËΩâÁõ§ÂãïÁï´
        const winnerAnimations = [
            "Monitor screen with video game level up.json",
            "Cat fishing on moon.json",
            "Generator.json",
            "Target.json",
            "Super Mario.json",
            "football Goal.json",
            "Formula One.json"
        ];
        
        const retroIcons = ["üëæ", "üöÄ", "üçÑ", "‚≠ê", "ü¶ñ", "üëª", "üíé", "üí£", "üéÆ", "üìÄ", "üîã", "‚öîÔ∏è"];

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const gamePage = document.getElementById('game-page');
        const joinCountEl = document.getElementById('join-count');
        const gameJoinCountEl = document.getElementById('game-join-count');
        const playerGridEl = document.getElementById('player-grid');
        const winnerModal = document.getElementById('winner-modal');
        const winnerNameEl = document.getElementById('modal-winner-name');
        const drawBtn = document.getElementById('draw-btn');
        
        // TV Elements
        const gameCanvas = document.getElementById('game-canvas');
        const tvLottie = document.getElementById('tv-lottie-player');

        // QR Code Setup
        const mobileUrl = window.location.origin + "/mobile.html";
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(mobileUrl)}`;

        // Socket Events
        socket.on('connect', () => socket.emit('admin_init'));
        socket.on('update_user_list', (u) => { 
            users = u; updateUI(); 
            if(document.getElementById('manage-modal').style.display === 'flex') renderManageList();
        });
        socket.on('update_winners', (w) => { winners = w; });
        socket.on('draw_result', (data) => {
            winners.push(data.winnerName);
            showWinner(data.winnerName);
        });
        socket.on('admin_draw_error', (msg) => { alert(msg); isDrawing=false; resetBtn(); });
        socket.on('event_reset', () => location.reload());

        function updateUI() {
            joinCountEl.innerText = users.length.toString().padStart(2, '0');
            gameJoinCountEl.innerText = users.length.toString().padStart(2, '0');
            playerGridEl.innerHTML = '';
            users.forEach((u, i) => {
                const icon = retroIcons[i % retroIcons.length];
                const div = document.createElement('div');
                div.className = 'char-box';
                div.innerHTML = `<div class="char-icon">${icon}</div><div class="char-name">${u}</div>`;
                playerGridEl.appendChild(div);
            });
        }

        function enterGame() {
            loginPage.style.opacity = 0;
            setTimeout(() => {
                loginPage.style.display = 'none';
                gamePage.classList.add('active');
                initCanvas();
                if(isMusicOn) bgmAudio.play().catch(()=>{});
            }, 500);
        }

        let drawResolver = null;
        async function startMultiDraw() {
            const valid = users.filter(u => !winners.includes(u) && !localExcluded.has(u)).length;
            if(valid === 0) { alert("GAME OVER (No players)"); return; }
            if(isDrawing) return;

            const count = parseInt(document.getElementById('draw-count').value) || 1;
            isDrawing = true; drawBtn.disabled = true;
            if(isMusicOn) bgmAudio.pause();

            for(let i=0; i<count; i++) {
                drawBtn.innerText = `DRAW ${i+1}/${count}`;
                await new Promise(resolve => {
                    socket.emit('admin_start_rolling');
                    startRolling();
                    setTimeout(() => { socket.emit('admin_perform_draw'); resolve(); }, 3500);
                });
                await new Promise(r => drawResolver = r);
                await new Promise(r => setTimeout(r, 500));
            }
            resetBtn();
            speak("ÊäΩÁçéÁµêÊùü");
        }

        function resetBtn() { 
            isDrawing = false; drawBtn.disabled = false; drawBtn.innerText = "SPIN"; 
            animState = 'idle';
            // ÊÅ¢Âæ©ÂæÖÊ©üÁï´Èù¢
            gameCanvas.style.display = 'block';
            tvLottie.style.display = 'none';
            tvLottie.stop();
            if(isMusicOn) bgmAudio.play().catch(()=>{});
        }

        function startRolling() {
            animState = 'rolling';
            // ÂàáÊèõÁï´Èù¢ÔºöÈö±Ëóè CanvasÔºåÈ°ØÁ§∫ Lottie ËΩâÁõ§
            gameCanvas.style.display = 'none';
            tvLottie.style.display = 'block';
            tvLottie.load(rollingAnimFile);
            tvLottie.play();

            // ËÅ≤Èü≥Âä†ÈÄü
            const s = Date.now();
            const tick = () => {
                if(animState!=='rolling') return;
                const p = (Date.now()-s)/3500;
                if(p<1) { playTick(100+p*400); setTimeout(tick, Math.max(40, 100*(1-p))); }
            }; tick();
        }

        function showWinner(name) {
            animState = 'idle';
            winnerNameEl.innerText = name;
            
            // ‚òÖ‚òÖ‚òÖ ÈõªË¶ñÁï´Èù¢ÂàáÊèõÁÇ∫Èö®Ê©üÂãïÁï´ ‚òÖ‚òÖ‚òÖ
            const randomAnim = winnerAnimations[Math.floor(Math.random() * winnerAnimations.length)];
            tvLottie.load(randomAnim);
            tvLottie.play(); // ÁπºÁ∫åÂú®ÈõªË¶ñË£°Êí≠ÊîæÊÖ∂Á•ùÂãïÁï´

            // È°ØÁ§∫ÂΩàÁ™ó
            winnerModal.classList.add('active');
            
            if(isMusicOn) bgmAudio.play().catch(()=>{});
            playWinSound(); speak("ÊÅ≠Âñú " + name); fireConfetti();
        }

        window.closeWinnerModal = function() {
            winnerModal.classList.remove('active');
            if(drawResolver) { drawResolver(); drawResolver = null; } else { resetBtn(); }
        }

        // Canvas (Pixel Art Style - Idle Screen)
        const cvs = document.getElementById('game-canvas');
        const ctx = cvs.getContext('2d');
        function initCanvas() { resize(); window.addEventListener('resize', resize); loop(); }
        function resize() { cvs.width = cvs.parentElement.offsetWidth; cvs.height = cvs.parentElement.offsetHeight; }
        
        function loop() {
            if (animState !== 'idle') {
                requestAnimationFrame(loop);
                return;
            }
            
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const cx = cvs.width/2; const cy = cvs.height/2;
            const valid = users.filter(u => !winners.includes(u) && !localExcluded.has(u));
            const list = valid.length ? valid : ["INSERT COIN"];

            ctx.font = '30px "Press Start 2P"';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

            // ÂæÖÊ©üÊôÇÈ°ØÁ§∫ÊªæÂãïÂêçÂ≠ó
            const t = Date.now()*0.002;
            for(let i=0; i<3; i++) {
                const idx = (Math.floor(t)+i) % list.length;
                const y = cy + (i-1)*60 + Math.sin(t+i)*10;
                ctx.fillStyle = `rgba(255,255,255,${0.5})`;
                if(list[idx]) ctx.fillText(list[idx], cx, y);
            }
            requestAnimationFrame(loop);
        }

        // Utils & Audio
        function toggleMusic() {
            isMusicOn = !isMusicOn;
            document.getElementById('music-btn').innerText = isMusicOn ? "MUSIC: ON" : "MUSIC: OFF";
            isMusicOn ? bgmAudio.play() : bgmAudio.pause();
        }
        function resetEvent() { if(confirm("RESET?")) socket.emit('admin_reset'); }
        
        let ac; function getAc() { if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)(); return ac; }
        function playTick(f) {
            const a = getAc(); const o=a.createOscillator(); const g=a.createGain();
            o.type='square'; o.frequency.value=f; g.gain.value=0.1;
            o.connect(g); g.connect(a.destination); o.start(); o.stop(a.currentTime+0.05);
        }
        function playWinSound() {
            const a = getAc(); const now = a.currentTime;
            [523, 659, 783, 1046, 523, 659, 783, 1046].forEach((f, i) => {
                const o=a.createOscillator(); const g=a.createGain();
                o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1, now+i*0.08); g.gain.exponentialRampToValueAtTime(0.01, now+i*0.08+0.05);
                o.connect(g); g.connect(a.destination); o.start(now+i*0.08); o.stop(now+i*0.08+0.1);
            });
        }
        function speak(t) { window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='zh-TW'; window.speechSynthesis.speak(u); }

        // Manage Modal
        window.openManageModal = () => { document.getElementById('manage-modal').style.display = 'flex'; renderManageList(); }
        window.closeManageModal = () => { document.getElementById('manage-modal').style.display = 'none'; }
        function renderManageList() {
            const div = document.getElementById('manage-list'); div.innerHTML = '';
            users.forEach(u => {
                const isEx = localExcluded.has(u); const isWon = winners.includes(u);
                const row = document.createElement('div'); row.className = 'manage-row';
                let action = `<button class="btn-start" style="padding:5px; font-size:0.6rem;" onclick="toggleEx('${u}')">${isEx?'RESTORE':'KICK'}</button>`;
                if(isWon) action = `<span style="color:gold">WINNER</span>`;
                row.innerHTML = `<span class="${isEx?'excluded':''}">${u}</span>${action}`;
                div.appendChild(row);
            });
        }
        window.toggleEx = (n) => { 
            if(localExcluded.has(n)) localExcluded.delete(n); else localExcluded.add(n); 
            socket.emit('admin_toggle_exclude', n); renderManageList(); 
        }
        
        const cf=document.getElementById('confetti-canvas'), cfx=cf.getContext('2d'); let ps=[];
        function fireConfetti(){ 
            cf.width=window.innerWidth; cf.height=window.innerHeight; ps=[]; 
            for(let i=0;i<100;i++) ps.push({
                x:cf.width/2, y:cf.height/2, vx:(Math.random()-0.5)*30, vy:(Math.random()-0.5)*30-10, 
                size: Math.random()*10+5, c:`hsl(${Math.random()*360},100%,50%)`
            }); 
            upCf(); 
        }
        function upCf(){ 
            cfx.clearRect(0,0,cf.width,cf.height); 
            ps.forEach((p,i)=>{ 
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; 
                if(p.y > cf.height) ps.splice(i,1);
                cfx.fillStyle=p.c; cfx.fillRect(p.x,p.y,p.size,p.size); 
            }); 
            if(ps.length) requestAnimationFrame(upCf); 
        }
    </script>
</body>
</html>
