<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRIGHT ARCADE DRAW</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+TC:wght@700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --sky-blue: #5C94FC;
            --cloud-white: #FFFFFF;
            --ground-orange: #C84C0C;
            --text-gold: #FFD700;
            --nes-black: #000000;
        }

        body {
            font-family: 'Press Start 2P', 'Noto Sans TC', monospace;
            background-color: var(--sky-blue);
            color: var(--nes-black);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            image-rendering: pixelated;
            user-select: none;
        }

        /* --- ËÉåÊôØ (Super Mario Style) --- */
        .game-world {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; overflow: hidden;
        }
        
        .pixel-cloud {
            position: absolute; background: #fff; width: 60px; height: 20px;
            box-shadow: 20px 0 #fff, 10px -20px #fff, 40px 0 #fff;
            opacity: 0.9; animation: drift linear infinite;
        }
        @keyframes drift { from { left: -150px; } to { left: 110%; } }

        .hills {
            position: absolute; bottom: 80px; left: 0; width: 100%; height: 200px;
            background: 
                radial-gradient(circle at 50% 100%, #00A800 20%, transparent 21%),
                radial-gradient(circle at 10% 100%, #008800 15%, transparent 16%);
            background-size: 300px 200px;
        }

        .ground-layer {
            position: absolute; bottom: 0; width: 100%; height: 80px;
            background-color: var(--ground-orange);
            background-image: 
                linear-gradient(335deg, rgba(0,0,0,0.1) 23px, transparent 23px),
                linear-gradient(155deg, rgba(0,0,0,0.1) 23px, transparent 23px);
            background-size: 58px 58px;
            border-top: 4px solid #000;
        }

        /* --- UI ÈÄöÁî® --- */
        #login-page, #game-page {
            position: relative; z-index: 10; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- 1. ÁôªÂÖ•È†Å --- */
        #login-page { padding-top: 40px; transition: opacity 0.5s; justify-content: flex-start; }

        .header-panel {
            background: #fff;
            border: 4px solid #000;
            padding: 20px 40px;
            display: flex; gap: 30px; align-items: center;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.2);
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .qr-frame { background: #000; padding: 5px; }
        #qr-img { width: 120px; height: 120px; display: block; background: #fff; image-rendering: pixelated; }

        .info-block { text-align: left; }
        .scan-text { 
            color: #000; font-size: 1.5rem; margin-bottom: 10px; 
            animation: bounce 1s infinite alternate; 
        }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-5px); } }

        .player-count-label { color: #555; font-size: 0.8rem; margin-top: 10px; }
        .player-count-num { font-size: 1.5rem; color: #E60012; text-shadow: 2px 2px 0 #000; }

        .btn-start {
            margin-top: 15px; padding: 10px 20px; font-family: inherit; font-size: 1rem;
            background: #00AA00; color: #fff; border: 4px solid #000; cursor: pointer;
            box-shadow: 4px 4px 0 #000; transition: transform 0.1s;
        }
        .btn-start:active { transform: translate(4px, 4px); box-shadow: none; }

        /* Áé©ÂÆ∂Á∂≤Ê†º */
        .player-grid {
            width: 90%; max-width: 1200px; flex: 1; 
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 15px;
            overflow-y: auto; padding: 10px; margin-bottom: 90px;
        }
        
        .char-box {
            width: 90px; height: 90px;
            background: #fff; border: 4px solid #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            animation: spawn 0.3s forwards; transform: scale(0);
        }
        @keyframes spawn { to { transform: scale(1); } }
        
        .char-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .char-name { font-size: 0.6rem; color: #000; text-align: center; word-break: break-all; font-family: 'Noto Sans TC'; }

        /* --- 2. ÊäΩÁçé‰∏ªÁï´Èù¢ (ÈõªË¶ñÊ©ü) --- */
        #game-page { display: none; opacity: 0; justify-content: center; }
        #game-page.active { display: flex; opacity: 1; }

        .machine-container { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; }
        
        /* Âæ©Âè§ÈõªË¶ñÊ©üÂ§ñÊ°Ü */
        .tv-frame {
            width: 85%; max-width: 900px; height: 500px;
            background-color: #333;
            border-radius: 30px;
            padding: 30px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 10px 10px 0 rgba(0,0,0,0.3);
            position: relative;
            display: flex; flex-direction: column; align-items: center;
            border: 4px solid #111;
        }

        .screen-area {
            width: 100%; height: 100%; background: #000;
            border-radius: 60px / 20px;
            position: relative; overflow: hidden;
            border: 4px solid #111;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
        }
        
        .screen-area::after {
            content: ''; position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 99;
        }

        /* ÂÖßÂÆπÂ±§ */
        #game-canvas { width: 100%; height: 100%; image-rendering: pixelated; position: absolute; top:0; left:0; z-index: 5;}
        
        /* Lottie Â±§ (ÂàùÂßãÈö±Ëóè) */
        #tv-lottie-player { 
            width: 100%; height: 100%; 
            position: absolute; top:0; left:0; 
            background: #000; z-index: 10;
            display: none; /* È†êË®≠‰∏çÈ°ØÁ§∫ */
        }

        /* ‚òÖ‚òÖ‚òÖ ËÆÄÂèñÁï´Èù¢ (Â°´Ë£úÈªëÂ±è) ‚òÖ‚òÖ‚òÖ */
        #tv-loading {
            position: absolute; z-index: 8;
            color: #00ff00; font-size: 1.5rem;
            display: none;
            text-align: center;
            animation: blink 0.5s infinite;
        }
        #tv-loading span { display: block; font-size: 3rem; margin-bottom: 10px; }

        /* ÊéßÂà∂Âè∞ */
        .control-bar {
            width: 100%; background: #222; padding: 20px;
            display: flex; justify-content: center; gap: 20px; align-items: center;
            border-top: 4px solid #fff; z-index: 20; flex-wrap: wrap; box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        
        .nes-input-group { display: flex; align-items: center; gap: 10px; color: #fff; font-size: 0.8rem; }
        .nes-input { background: #000; border: 2px solid #fff; color: #fff; font-family: inherit; font-size: 1rem; width: 60px; text-align: center; outline: none; }
        .credits-text { width: 100%; text-align: center; color: var(--text-gold); margin-top: 10px; font-size: 0.8rem; text-shadow: 2px 2px 0 #000; }

        /* --- 3. ‰∏≠ÁçéÂΩàÁ™ó (Á¥îÊñáÂ≠ó) --- */
        #winner-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            display: none; flex-direction: column; align-items: center; justify-content: flex-end;
            padding-bottom: 50px;
        }
        #winner-modal.active { display: flex; }

        .winner-panel {
            background: #fff; border: 4px solid #000;
            padding: 40px 80px; text-align: center; position: relative;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.5);
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: 20px; min-width: 300px;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .winner-header { color: #E60012; font-size: 1.5rem; margin-bottom: 20px; }
        .winner-trophy { font-size: 4rem; margin-bottom: 10px; display: block; }
        .winner-name { font-size: 3.5rem; color: #000; margin: 10px 0 30px 0; text-shadow: 2px 2px 0 #ccc; }

        /* --- ÁÆ°ÁêÜÂΩàÁ™ó --- */
        #manage-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; align-items: center; justify-content: center; }
        #manage-modal.active { display: flex; }
        .manage-box { width: 80%; max-width: 600px; height: 70vh; background: #fff; border: 4px solid #000; display: flex; flex-direction: column; padding: 20px; color: #000; box-shadow: 8px 8px 0 rgba(0,0,0,0.5); }
        .manage-list { flex: 1; overflow-y: auto; border: 2px solid #000; margin: 15px 0; font-family: 'Noto Sans TC'; }
        .manage-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px dashed #ccc; align-items: center; }
        .excluded { text-decoration: line-through; color: #999; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
    </style>
</head>
<body>

    <div class="game-world">
        <div class="pixel-cloud" style="top: 10%; animation-duration: 25s;"></div>
        <div class="pixel-cloud" style="top: 30%; animation-duration: 40s; transform: scale(1.5);"></div>
        <div class="hills"></div>
        <div class="ground-layer"></div>
    </div>

    <!-- 1. ÁôªÂÖ•È†Å -->
    <div id="login-page">
        <div class="header-panel">
            <div style="text-align: center;">
                <div class="qr-frame"><img id="qr-img" src="" alt="QR"></div>
            </div>
            <div class="info-block">
                <div class="scan-text">SCAN TO JOIN</div>
                <div class="player-count-label">PLAYERS READY</div>
                <div class="player-count-num" id="join-count">00</div>
                <button class="btn-start" onclick="enterGame()">START GAME</button>
            </div>
        </div>
        <div class="player-grid" id="player-grid"></div>
    </div>

    <!-- 2. ÈÅäÊà≤‰∏ªÁï´Èù¢ -->
    <div id="game-page">
        <div class="machine-container">
            <div class="tv-frame">
                <div class="screen-area">
                    <!-- ÂæÖÊ©üÊñáÂ≠ó (INSERT COIN) -->
                    <canvas id="game-canvas"></canvas>
                    
                    <!-- ÊäΩÁçéÂãïÁï´ (Lottie) -->
                    <lottie-player id="tv-lottie-player" background="#000" speed="1" loop autoplay></lottie-player>
                    
                    <!-- ‚òÖ‚òÖ‚òÖ ËÆÄÂèñÁï´Èù¢ (Â°´Ë£úÈªëÂ±è) ‚òÖ‚òÖ‚òÖ -->
                    <div id="tv-loading">
                        <span>‚åõ</span>
                        LOADING...
                    </div>
                </div>
            </div>
        </div>
        <div class="control-bar">
            <button class="btn-start" style="background:#E60012;" id="draw-btn" onclick="startMultiDraw()">SPIN</button>
            <div class="nes-input-group">
                <label>COUNT:</label>
                <input type="number" class="nes-input" id="draw-count" value="1" min="1" max="50">
            </div>
            <button class="btn-start" style="background:#008800;" onclick="toggleMusic()" id="music-btn">MUSIC: ON</button>
            <button class="btn-start" style="background:#0000AA;" onclick="openManageModal()">ROSTER</button>
            <button class="btn-start" style="background:#333;" onclick="resetEvent()">RESET</button>
            <div class="credits-text">CREDITS: <span id="game-join-count">0</span></div>
        </div>
    </div>

    <!-- 3. ‰∏≠ÁçéÂΩàÁ™ó -->
    <div id="winner-modal" onclick="closeWinnerModal()">
        <div class="winner-panel" onclick="event.stopPropagation()">
            <div class="winner-header">‚òÖ WINNER! ‚òÖ</div>
            <div class="winner-trophy">üèÜ</div>
            <div class="winner-name" id="modal-winner-name">NAME</div>
            <button class="btn-start" style="background:#0000AA;" onclick="closeWinnerModal()">CONTINUE</button>
        </div>
    </div>

    <!-- ÁÆ°ÁêÜÂΩàÁ™ó -->
    <div id="manage-modal" onclick="closeManageModal()">
        <div class="manage-box" onclick="event.stopPropagation()">
            <div style="color:#000; text-align:center;">PLAYER LIST</div>
            <div class="manage-list" id="manage-list"></div>
            <div style="text-align:right;">
                <button class="btn-start" onclick="closeManageModal()">OK</button>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>

    <script>
        const socket = io();
        let users = [];
        let winners = [];
        let localExcluded = new Set();
        let isDrawing = false;
        let animState = 'idle';
        let scrollY = 0;

        // BGM
        const bgmAudio = new Audio('https://commondatastorage.googleapis.com/codeskulptor-demos/riceracer_assets/music/race1.ogg'); 
        bgmAudio.loop = true; bgmAudio.volume = 0.3;
        let isMusicOn = true;

        // ‚òÖ‚òÖ‚òÖ Èö®Ê©üÂãïÁï´Â∫´ (8ÂÄãÊ™îÊ°à) ‚òÖ‚òÖ‚òÖ
        // Ë´ãÁ¢∫‰øùÈÄô‰∫õÊ™îÊ°àÂ∑≤‰∏äÂÇ≥Ëá≥ public/
        const animationPool = [
            "Emos Spin.json",
            "Monitor screen with video game level up.json",
            "Cat fishing on moon.json",
            "Generator.json",
            "Target.json",
            "Super Mario.json",
            "football Goal.json",
            "Formula One.json"
        ];
        
        const retroIcons = ["üëæ", "üöÄ", "üçÑ", "‚≠ê", "ü¶ñ", "üëª", "üíé", "üí£", "üéÆ", "üìÄ", "üîã", "‚öîÔ∏è"];

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const gamePage = document.getElementById('game-page');
        const joinCountEl = document.getElementById('join-count');
        const gameJoinCountEl = document.getElementById('game-join-count');
        const playerGridEl = document.getElementById('player-grid');
        const winnerModal = document.getElementById('winner-modal');
        const winnerNameEl = document.getElementById('modal-winner-name');
        const drawBtn = document.getElementById('draw-btn');
        
        const gameCanvas = document.getElementById('game-canvas');
        const tvLottie = document.getElementById('tv-lottie-player');
        const tvLoading = document.getElementById('tv-loading');

        const mobileUrl = window.location.origin + "/mobile.html";
        document.getElementById('qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(mobileUrl)}`;

        // Socket Events
        socket.on('connect', () => socket.emit('admin_init'));
        socket.on('update_user_list', (u) => { 
            users = u; updateUI(); 
            if(document.getElementById('manage-modal').style.display === 'flex') renderManageList();
        });
        socket.on('update_winners', (w) => { winners = w; });
        socket.on('draw_result', (data) => {
            winners.push(data.winnerName);
            showWinner(data.winnerName);
        });
        socket.on('admin_draw_error', (msg) => { alert(msg); isDrawing=false; resetBtn(); });
        socket.on('event_reset', () => location.reload());

        function updateUI() {
            joinCountEl.innerText = users.length.toString().padStart(2, '0');
            gameJoinCountEl.innerText = users.length.toString().padStart(2, '0');
            playerGridEl.innerHTML = '';
            users.forEach((u, i) => {
                const icon = retroIcons[i % retroIcons.length];
                const div = document.createElement('div');
                div.className = 'char-box';
                div.innerHTML = `<div class="char-icon">${icon}</div><div class="char-name">${u}</div>`;
                playerGridEl.appendChild(div);
            });
        }

        function enterGame() {
            loginPage.style.opacity = 0;
            setTimeout(() => {
                loginPage.style.display = 'none';
                gamePage.classList.add('active');
                initCanvas();
                if(isMusicOn) bgmAudio.play().catch(()=>{});
            }, 500);
        }

        let drawResolver = null;
        async function startMultiDraw() {
            const valid = users.filter(u => !winners.includes(u) && !localExcluded.has(u)).length;
            if(valid === 0) { alert("GAME OVER (No players)"); return; }
            if(isDrawing) return;

            const count = parseInt(document.getElementById('draw-count').value) || 1;
            isDrawing = true; drawBtn.disabled = true;
            if(isMusicOn) bgmAudio.pause();

            for(let i=0; i<count; i++) {
                drawBtn.innerText = `DRAW ${i+1}/${count}`;
                await new Promise(resolve => {
                    socket.emit('admin_start_rolling');
                    
                    // ‚òÖ‚òÖ‚òÖ ÂïüÂãïÊäΩÁçéÁï´Èù¢ ‚òÖ‚òÖ‚òÖ
                    startRolling();
                    
                    // ‚òÖ‚òÖ‚òÖ Âª∂Èï∑Ëá≥ 5 ÁßíÔºåÁ¢∫‰øùÂãïÁï´ÊúâÊôÇÈñìÊí≠Êîæ ‚òÖ‚òÖ‚òÖ
                    setTimeout(() => { socket.emit('admin_perform_draw'); resolve(); }, 5000);
                });
                await new Promise(r => drawResolver = r);
                await new Promise(r => setTimeout(r, 500));
            }
            resetBtn();
            speak("ÊäΩÁçéÁµêÊùü");
        }

        function resetBtn() { 
            isDrawing = false; drawBtn.disabled = false; drawBtn.innerText = "SPIN"; 
            animState = 'idle';
            
            gameCanvas.style.display = 'block'; // È°ØÁ§∫ INSERT COIN
            tvLottie.style.display = 'none';
            tvLoading.style.display = 'none';
            tvLottie.stop();
            
            if(isMusicOn) bgmAudio.play().catch(()=>{});
        }

        function startRolling() {
            animState = 'rolling';
            
            // 1. Èö±ËóèÂæÖÊ©üÊñáÂ≠óÔºåÈ°ØÁ§∫ Loading
            gameCanvas.style.display = 'none';
            tvLottie.style.display = 'none';
            tvLoading.style.display = 'block';

            // 2. Èö®Ê©üÈÅ∏‰∏ÄÂÄãÂãïÁï´
            const randomAnim = animationPool[Math.floor(Math.random() * animationPool.length)];
            
            // 3. ËôïÁêÜÊ™îÂêçÁ©∫Ê†º‰∏¶ËºâÂÖ• (Á¢∫‰øùË∑ØÂæëÊ≠£Á¢∫)
            tvLottie.load(encodeURIComponent(randomAnim));

            // 4. Áõ£ËÅΩËºâÂÖ•ÂÆåÊàê‰∫ã‰ª∂ÔºåÊàñÂª∂ÈÅ≤È°ØÁ§∫
            // Á∞°ÂñÆÂÅöÊ≥ïÔºöÂª∂ÈÅ≤ 0.8 ÁßíÂæåÈ°ØÁ§∫ÂãïÁï´ÔºåÈö±Ëóè Loading
            setTimeout(() => {
                tvLoading.style.display = 'none';
                tvLottie.style.display = 'block';
                tvLottie.play();
            }, 800);

            // 5. ËÅ≤Èü≥Âä†ÈÄüÁâπÊïà
            const s = Date.now();
            const tick = () => {
                if(animState!=='rolling') return;
                const p = (Date.now()-s)/5000;
                if(p<1) { playTick(100+p*400); setTimeout(tick, Math.max(40, 100*(1-p))); }
            }; tick();
        }

        function showWinner(name) {
            animState = 'idle';
            winnerNameEl.innerText = name;
            
            // ‚òÖ‚òÖ‚òÖ ÂÅúÊ≠¢ÂãïÁï´ÔºåÈ°ØÁ§∫‰∏≠ÁçéÂΩàÁ™ó ‚òÖ‚òÖ‚òÖ
            tvLottie.pause();
            winnerModal.classList.add('active');
            
            if(isMusicOn) bgmAudio.play().catch(()=>{});
            playWinSound(); speak("ÊÅ≠Âñú " + name); fireConfetti();
        }

        window.closeWinnerModal = function() {
            winnerModal.classList.remove('active');
            if(drawResolver) { drawResolver(); drawResolver = null; } else { resetBtn(); }
        }

        // Canvas (ÂæÖÊ©üÁï´Èù¢)
        const cvs = document.getElementById('game-canvas');
        const ctx = cvs.getContext('2d');
        function initCanvas() { resize(); window.addEventListener('resize', resize); loop(); }
        function resize() { cvs.width = cvs.parentElement.offsetWidth; cvs.height = cvs.parentElement.offsetHeight; }
        
        function loop() {
            if (animState !== 'idle') { requestAnimationFrame(loop); return; }
            
            ctx.clearRect(0,0,cvs.width,cvs.height);
            const cx = cvs.width/2; const cy = cvs.height/2;
            const valid = users.filter(u => !winners.includes(u) && !localExcluded.has(u));
            const list = valid.length ? valid : ["INSERT COIN"];

            ctx.font = '30px "Press Start 2P"';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

            const t = Date.now()*0.002;
            for(let i=0; i<3; i++) {
                const idx = (Math.floor(t)+i) % list.length;
                const y = cy + (i-1)*60 + Math.sin(t+i)*10;
                ctx.fillStyle = `rgba(255,255,255,${0.5})`;
                if(list[idx]) ctx.fillText(list[idx], cx, y);
            }
            requestAnimationFrame(loop);
        }

        function toggleMusic() {
            isMusicOn = !isMusicOn;
            document.getElementById('music-btn').innerText = isMusicOn ? "MUSIC: ON" : "MUSIC: OFF";
            isMusicOn ? bgmAudio.play() : bgmAudio.pause();
        }
        function resetEvent() { if(confirm("RESET?")) socket.emit('admin_reset'); }
        
        let ac; function getAc() { if(!ac) ac = new (window.AudioContext||window.webkitAudioContext)(); return ac; }
        function playTick(f) {
            const a = getAc(); const o=a.createOscillator(); const g=a.createGain();
            o.type='square'; o.frequency.value=f; g.gain.value=0.1;
            o.connect(g); g.connect(a.destination); o.start(); o.stop(a.currentTime+0.05);
        }
        function playWinSound() {
            const a = getAc(); const now = a.currentTime;
            [523, 659, 783, 1046, 523, 659, 783, 1046].forEach((f, i) => {
                const o=a.createOscillator(); const g=a.createGain();
                o.type='square'; o.frequency.value=f; g.gain.setValueAtTime(0.1, now+i*0.08); g.gain.exponentialRampToValueAtTime(0.01, now+i*0.08+0.05);
                o.connect(g); g.connect(a.destination); o.start(now+i*0.08); o.stop(now+i*0.08+0.1);
            });
        }
        function speak(t) { window.speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='zh-TW'; window.speechSynthesis.speak(u); }

        window.openManageModal = () => { document.getElementById('manage-modal').style.display = 'flex'; renderManageList(); }
        window.closeManageModal = () => { document.getElementById('manage-modal').style.display = 'none'; }
        function renderManageList() {
            const div = document.getElementById('manage-list'); div.innerHTML = '';
            users.forEach(u => {
                const isEx = localExcluded.has(u); const isWon = winners.includes(u);
                const row = document.createElement('div'); row.className = 'manage-row';
                let action = `<button class="btn-start" style="padding:5px; font-size:0.6rem;" onclick="toggleEx('${u}')">${isEx?'RESTORE':'KICK'}</button>`;
                if(isWon) action = `<span style="color:#E60012">WINNER</span>`;
                row.innerHTML = `<span class="${isEx?'excluded':''}">${u}</span>${action}`;
                div.appendChild(row);
            });
        }
        window.toggleEx = (n) => { 
            if(localExcluded.has(n)) localExcluded.delete(n); else localExcluded.add(n); 
            socket.emit('admin_toggle_exclude', n); renderManageList(); 
        }
        
        const cf=document.getElementById('confetti-canvas'), cfx=cf.getContext('2d'); let ps=[];
        function fireConfetti(){ 
            cf.width=window.innerWidth; cf.height=window.innerHeight; ps=[]; 
            for(let i=0;i<100;i++) ps.push({
                x:cf.width/2, y:cf.height/2, vx:(Math.random()-0.5)*30, vy:(Math.random()-0.5)*30-10, 
                size: Math.random()*10+5, c:`hsl(${Math.random()*360},100%,50%)`
            }); 
            upCf(); 
        }
        function upCf(){ 
            cfx.clearRect(0,0,cf.width,cf.height); 
            ps.forEach((p,i)=>{ 
                p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; 
                if(p.y > cf.height) ps.splice(i,1);
                cfx.fillStyle=p.c; cfx.fillRect(p.x,p.y,p.size,p.size); 
            }); 
            if(ps.length) requestAnimationFrame(upCf); 
        }
    </script>
</body>
</html>
